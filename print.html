<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Rusty Ruby Book</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="The definitive guide for building Ruby native gems using Rust">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="background-and-concepts.html"><strong aria-hidden="true">2.</strong> Background and Concepts</a></li><li class="chapter-item expanded affix "><li class="part-title">Tutorial</li><li class="chapter-item expanded "><a href="tutorial/setup.html"><strong aria-hidden="true">3.</strong> Setup</a></li><li class="chapter-item expanded "><a href="tutorial/hello-world.html"><strong aria-hidden="true">4.</strong> Hello World!</a></li><li class="chapter-item expanded "><a href="tutorial/testing.html"><strong aria-hidden="true">5.</strong> Testing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tutorial/testing/debugging.html"><strong aria-hidden="true">5.1.</strong> Debugging</a></li></ol></li><li class="chapter-item expanded "><a href="tutorial/publishing.html"><strong aria-hidden="true">6.</strong> Publishing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tutorial/publishing/cross-compilation.html"><strong aria-hidden="true">6.1.</strong> Cross-Compilation</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rusty Ruby Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rust--ruby"><a class="header" href="#rust--ruby">Rust ‚ù§Ô∏è Ruby</a></h1>
<p>This book describes how to use <a href="https://www.rust-lang.org">Rust</a> to build fast, reliable and secure native gems for Ruby. You may be new to Rust,
and that's OK! You'll find that Rust has many of the things you love about Ruby. And unlike C, incorrect code will
usually fail at compile time rather than bringing down production.</p>
<p>By the end of this book, you will be confident to build, test, and deploy a Rusty Ruby gem of your own!</p>
<p>Let's get started by learning about <a href="./background-and-concepts.html">how native Ruby gems work</a>.</p>
<blockquote>
<p><strong>üí° Tip:</strong> You can search through this book by clicking on the üîç icon at the top of the page, or by pressing the <code>s</code>
key.</p>
</blockquote>
<h2 id="contributing-to-this-book"><a class="header" href="#contributing-to-this-book">Contributing to this book</a></h2>
<p>This book is open source! Find a typo? Did we overlook something? <a href="https://github.com/oxidize-rb/rb-sys"><strong>Send us a pull request!</strong></a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="background-and-concepts"><a class="header" href="#background-and-concepts">Background and Concepts</a></h1>
<h2 id="what-is-a-native-extension"><a class="header" href="#what-is-a-native-extension">What is a native extension?</a></h2>
<p>Typically, Ruby code is compiled to a special instruction set which executes on a stack-based virtual machine. You can
see what these instructions look like by running:</p>
<pre><code class="language-sh">$ ruby --dump=insns -e '2 + 3'
== disasm: #&lt;ISeq:&lt;main&gt;@-e:1 (1,0)-(1,5)&gt; (catch: FALSE)
0000 putobject         2           (   1)[Li]
0002 putobject         3
0004 opt_plus          &lt;calldata!mid:+, argc:1, ARGS_SIMPLE&gt;[CcCr]
0006 leave
</code></pre>
<p>In this example, <code>2</code> and <code>3</code> are pushed onto the stack, and then <code>opt_plus</code> performs the addition.</p>
<p>For a native gem, we bypass this mechanism entirely and instead exposes native machine code to Ruby. In our native code,
we can use the <a href="https://docs.ruby-lang.org/en/3.1/extension_rdoc.html">Ruby C API</a> to interact with the Ruby VM.</p>
<h2 id="how-are-native-gems-loaded"><a class="header" href="#how-are-native-gems-loaded">How are native Gems loaded?</a></h2>
<p>Under the hood, native extensions are compiled as shared libraries (<code>.so</code>, <code>.bundle</code>, etc.). When you
<code>require 'some_gem'</code>, if Ruby finds a <code>some_gem.(so|bundle|lib)</code>, the shared library loaded on demand using <a href="https://man7.org/linux/man-pages/man3/dlopen.3.html">dlopen</a> (or
the system equivalent). After that, Ruby will call <code>Init_some_gem</code> so the native library can do its magic.</p>
<h2 id="why-does-it-work-with-rust-and-not-other-languages"><a class="header" href="#why-does-it-work-with-rust-and-not-other-languages">Why does it work with Rust and not other languages?</a></h2>
<p>C is often referred to as the &quot;lingua franca&quot; of the programming language world, and Rust is fluent. Rust can compile
functions to be compatible with the C calling conventions, and align items in memory in a way that C understands. Rust
also does not have a garbage collector, which makes integration signifcantly easier.</p>
<p>When Ruby loads a gem extension written in Rust, it has no idea the gem is actually written in Rust. Due to Rust's
robust C FFI, you can code anything in Rust that you could with C.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup"><a class="header" href="#setup">Setup</a></h1>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="testing"><a class="header" href="#testing">Testing</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="debugging"><a class="header" href="#debugging">Debugging</a></h1>
<p>To debug Rust extensions, you can use either LLDB or GDB. First, you will need to compile with the <code>dev</code> Cargo profile,
so debug symbols are available.</p>
<p>To do that you can run: <code>RB_SYS_CARGO_PROFILE=dev rake compile</code>. Alternatively, you can add a helper Rake task to make
this easier:</p>
<pre><code class="language-ruby"># Rakefile

desc &quot;Compile the extension with debug symbols&quot;
task &quot;compile:debug&quot; do
  ENV[&quot;RB_SYS_CARGO_PROFILE&quot;] = &quot;dev&quot;
  Rake::Task[&quot;compile&quot;].invoke
end
</code></pre>
<h2 id="vscode--lldb"><a class="header" href="#vscode--lldb">VSCode + LLDB</a></h2>
<p>The <a href="tutorial/testing/">code-lldb</a> extension for VSCode is a great way to debug Rust code. Here is an example configuration file:</p>
<pre><code class="language-json">// .vscode/launch.json
{
  &quot;version&quot;: &quot;0.2.0&quot;,
  &quot;configurations&quot;: [
    {
      &quot;type&quot;: &quot;lldb&quot;,
      &quot;request&quot;: &quot;launch&quot;,
      &quot;name&quot;: &quot;Debug&quot;,
      &quot;preLaunchTask&quot;: {
        &quot;task&quot;: &quot;compile:debug&quot;,
        &quot;type&quot;: &quot;rake&quot;
      },
      &quot;program&quot;: &quot;~/.asdf/installs/ruby/3.1.1/bin/ruby&quot;,
      &quot;args&quot;: [&quot;-Ilib&quot;, &quot;test/test_helper.rb&quot;],
      &quot;cwd&quot;: &quot;${workspaceFolder}&quot;,
      &quot;sourceLanguages&quot;: [&quot;rust&quot;]
    }
  ]
}
</code></pre>
<h3 id="debugging-the-ruby-c-api"><a class="header" href="#debugging-the-ruby-c-api">Debugging the Ruby C API</a></h3>
<p>With this basic setup, you can set breakpoints and interactively debug your Rust code. However, if Ruby is not built
with debug symbols, any calls into the Ruby C API become a black box. Luckily, it's straight-forward to fix this.</p>
<h4 id="compiling-ruby-with-debug-symbols-and-source-code"><a class="header" href="#compiling-ruby-with-debug-symbols-and-source-code">Compiling Ruby with debug symbols and source code</a></h4>
<h4 id="using-chruby-or-ruby-build"><a class="header" href="#using-chruby-or-ruby-build">Using <a href="https://github.com/postmodern/chruby"><code>chruby</code></a> or <a href="https://github.com/rbenv/ruby-build"><code>ruby-build</code></a></a></h4>
<ol>
<li>
<p>First, compile Ruby like so:</p>
<pre><code class="language-sh">$ RUBY_CFLAGS=&quot;-Og -ggdb&quot; ruby-build --keep 3.1.2 /opt/rubies/3.1.2-debug
</code></pre>
</li>
<li>
<p>Make sure your <code>.vscode/launch.json</code> file is configured to use <code>/opt/rubies/3.1.2-debug/bin/ruby</code>.</p>
</li>
</ol>
<h4 id="using-rbenv"><a class="header" href="#using-rbenv">Using <a href="https://github.com/rbenv/rbenv"><code>rbenv</code></a></a></h4>
<ol>
<li>
<p>First, compile Ruby like so:</p>
<pre><code class="language-sh">$ RUBY_CFLAGS=&quot;-Og -ggdb&quot; rbenv install --keep 3.1.2
</code></pre>
</li>
<li>
<p>Make sure your <code>.vscode/launch.json</code> file is configured to use <code>$RBENV_ROOT/versions/3.1.2/bin/ruby</code>.</p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="publishing"><a class="header" href="#publishing">Publishing</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cross-compilation"><a class="header" href="#cross-compilation">Cross-Compilation</a></h1>
<p>TODO!</p>
<h2 id="resource"><a class="header" href="#resource">Resource</a></h2>
<ul>
<li><a href="https://github.com/oxidize-rb/cross-gem-action">Cross Gem Action</a> to easily cross compile with GitHub actions</li>
<li><a href="https://index.docker.io/u/rbsys">Docker images compatible with <code>rake-compiler-dock</code></a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
