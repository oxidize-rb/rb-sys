<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-development-approaches" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Development Approaches | oxidize.rb</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://oxidize-rb.org/img/social-card.png"><meta data-rh="true" name="twitter:image" content="https://oxidize-rb.org/img/social-card.png"><meta data-rh="true" property="og:url" content="https://oxidize-rb.org/docs/development-approaches"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Development Approaches | oxidize.rb"><meta data-rh="true" name="description" content="When building Ruby extensions with Rust and rb-sys, you have two main approaches to choose from:"><meta data-rh="true" property="og:description" content="When building Ruby extensions with Rust and rb-sys, you have two main approaches to choose from:"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://oxidize-rb.org/docs/development-approaches"><link data-rh="true" rel="alternate" href="https://oxidize-rb.org/docs/development-approaches" hreflang="en"><link data-rh="true" rel="alternate" href="https://oxidize-rb.org/docs/development-approaches" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.3a8f2e98.css">
<script src="/assets/js/runtime~main.70249b01.js" defer="defer"></script>
<script src="/assets/js/main.bbfa9ded.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?t("light"):t("dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo-oxidize-rb.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" aria-label="oxidize.rb home page" href="/"><img src="/img/logo-oxidize-rb.svg" alt="oxidize.rb Logo" width="32" height="32"><span class="navbar__title">oxidize.rb</span></a><a class="navbar__item navbar__link" href="/docs/">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/oxidize-rb/rb-sys" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div></nav><div class="main-wrapper mainWrapper_eExm"><main class="mainContent_VsED"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><div class="theme-doc-markdown markdown"><header><h1>Development Approaches</h1></header>
<p>When building Ruby extensions with Rust and rb-sys, you have two main approaches to choose from:</p>
<ol>
<li><strong>Direct rb-sys usage</strong>: Working directly with Ruby&#x27;s C API through the rb-sys bindings</li>
<li><strong>Higher-level wrappers</strong>: Using libraries like Magnus that build on top of rb-sys</li>
</ol>
<p>This chapter will help you understand when to use each approach and how to mix them when needed.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="direct-rb-sys-usage">Direct rb-sys Usage<a href="#direct-rb-sys-usage" class="hash-link" aria-label="Direct link to Direct rb-sys Usage" title="Direct link to Direct rb-sys Usage">​</a></h2>
<p>The rb-sys crate provides low-level bindings to Ruby&#x27;s C API. This approach gives you complete control over how your
Rust code interacts with Ruby.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-direct-rb-sys">When to Use Direct rb-sys<a href="#when-to-use-direct-rb-sys" class="hash-link" aria-label="Direct link to When to Use Direct rb-sys" title="Direct link to When to Use Direct rb-sys">​</a></h3>
<ul>
<li>When you need maximum control over Ruby VM interaction</li>
<li>For specialized extensions that need access to low-level Ruby internals</li>
<li>When performance is absolutely critical and you need to eliminate any overhead</li>
<li>When implementing functionality not yet covered by higher-level wrappers</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-simple-extension-with-direct-rb-sys">Example: Simple Extension with Direct rb-sys<a href="#example-simple-extension-with-direct-rb-sys" class="hash-link" aria-label="Direct link to Example: Simple Extension with Direct rb-sys" title="Direct link to Example: Simple Extension with Direct rb-sys">​</a></h3>
<p>Here&#x27;s a simple example of a Ruby extension using direct rb-sys:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:hsl(35, 15%, 88%);--prism-background-color:hsl(220, 18%, 10%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:hsl(35, 15%, 88%);background-color:hsl(220, 18%, 10%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token keyword" style="color:hsl(200, 85%, 65%)">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">rb_sys</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    rb_define_module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> rb_define_module_function</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> rb_str_new_cstr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    rb_string_value_cstr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">std</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token namespace" style="opacity:0.7">ffi</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token class-name">CString</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">std</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token namespace" style="opacity:0.7">os</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token namespace" style="opacity:0.7">raw</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token plain">c_char</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Helper macro for creating C strings</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token macro property" style="color:hsl(5, 65%, 75%)">macro_rules!</span><span class="token plain"> cstr </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token variable" style="color:hsl(5, 65%, 75%)">$s</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token fragment-specifier punctuation" style="color:hsl(220, 10%, 65%)">expr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">concat!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token variable" style="color:hsl(5, 65%, 75%)">$s</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;\0&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">as_ptr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">as</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">*</span><span class="token keyword" style="color:hsl(200, 85%, 65%)">const</span><span class="token plain"> c_char</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Reverse a string</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">extern</span><span class="token plain"> </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;C&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">reverse</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">_</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> c_str </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token function" style="color:hsl(5, 65%, 65%)">rb_string_value_cstr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&amp;</span><span class="token plain">s</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> rust_str </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">std</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token namespace" style="opacity:0.7">ffi</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token class-name">CStr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">from_ptr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">c_str</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">to_str</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">unwrap</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> reversed </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> rust_str</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">chars</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">rev</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">collect</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">::</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token class-name">String</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> c_string </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token class-name">CString</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">new</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">reversed</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">unwrap</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token function" style="color:hsl(5, 65%, 65%)">rb_str_new_cstr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">c_string</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">as_ptr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Module initialization function</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token attribute attr-name" style="color:hsl(200, 85%, 70%)">#[no_mangle]</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">pub</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">extern</span><span class="token plain"> </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;C&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">Init_string_utils</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> module </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token function" style="color:hsl(5, 65%, 65%)">rb_define_module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token macro property" style="color:hsl(5, 65%, 75%)">cstr!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;StringUtils&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token function" style="color:hsl(5, 65%, 65%)">rb_define_module_function</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">cstr!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;reverse&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token class-name">Some</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">reverse </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">as</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">extern</span><span class="token plain"> </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;C&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token number" style="color:hsl(5, 65%, 75%)">1</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-rb_thread_call_without_gvl-for-performance">Using rb_thread_call_without_gvl for Performance<a href="#using-rb_thread_call_without_gvl-for-performance" class="hash-link" aria-label="Direct link to Using rb_thread_call_without_gvl for Performance" title="Direct link to Using rb_thread_call_without_gvl for Performance">​</a></h3>
<p>When performing computationally intensive operations, it&#x27;s important to release Ruby&#x27;s Global VM Lock (GVL) to allow
other threads to run. The <code>rb_thread_call_without_gvl</code> function provides this capability:</p>
<div class="languageCallout_VNpC rust_PB7z"><div class="header_itAP"><div class="icon_vHP_"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" height="20" width="20"><circle cx="12" cy="12" r="8"></circle><path d="M12 4v2M12 18v2M4 12H6M18 12h2M6.34 6.34l1.42 1.42M16.24 16.24l1.42 1.42M6.34 17.66l1.42-1.42M16.24 7.76l1.42-1.42"></path><path d="M9 12a3 3 0 1 0 6 0 3 3 0 0 0-6 0z"></path></svg></div><div class="title_Bire">Thread-Safe Operations without the GVL</div></div><div class="content_ZrzH"><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:hsl(35, 15%, 88%);--prism-background-color:hsl(220, 18%, 10%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:hsl(35, 15%, 88%);background-color:hsl(220, 18%, 10%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token keyword" style="color:hsl(200, 85%, 65%)">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">magnus</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token class-name">Error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">RString</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">rb_sys</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token plain">rb_thread_call_without_gvl</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">std</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token namespace" style="opacity:0.7">ffi</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token plain">c_void</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">panic</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token keyword" style="color:hsl(200, 85%, 65%)">self</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">AssertUnwindSafe</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">ptr</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token plain">null_mut</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">/// Execute a function without holding the Global VM Lock (GVL).</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">/// This allows other Ruby threads to run while performing CPU-intensive tasks.</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">///</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">/// # Safety</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">///</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">/// The passed function must not interact with the Ruby VM or Ruby objects</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">/// as it runs without the GVL, which is required for safe Ruby operations.</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">///</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">/// # Returns</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">///</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">/// Returns the result of the function or a magnus::Error if the function panics.</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">pub</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">nogvl</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token class-name">F</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">R</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">func</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token class-name">F</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token class-name">R</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token class-name">F</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token class-name">FnOnce</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token class-name">R</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token class-name">R</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token class-name">Send</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">+</span><span class="token plain"> </span><span class="token lifetime-annotation symbol" style="color:hsl(5, 65%, 75%)">&#x27;static</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">struct</span><span class="token plain"> </span><span class="token type-definition class-name">CallbackData</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token class-name">F</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">R</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        func</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token class-name">F</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        result</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token class-name">Result</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token class-name">R</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;&gt;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Store either the result or a panic message</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">extern</span><span class="token plain"> </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;C&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">call_without_gvl</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token class-name">F</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">R</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">*</span><span class="token keyword" style="color:hsl(200, 85%, 65%)">mut</span><span class="token plain"> c_void</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">*</span><span class="token keyword" style="color:hsl(200, 85%, 65%)">mut</span><span class="token plain"> c_void</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token class-name">F</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token class-name">FnOnce</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token class-name">R</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token class-name">R</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token class-name">Send</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">+</span><span class="token plain"> </span><span class="token lifetime-annotation symbol" style="color:hsl(5, 65%, 75%)">&#x27;static</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Safety: We know this pointer is valid because we just created it below</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> data </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">&amp;</span><span class="token keyword" style="color:hsl(200, 85%, 65%)">mut</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">*</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">data </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">as</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">*</span><span class="token keyword" style="color:hsl(200, 85%, 65%)">mut</span><span class="token plain"> </span><span class="token class-name">CallbackData</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token class-name">F</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">R</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Use take() to move out of the Option, ensuring we don&#x27;t try to run the function twice</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">if</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">func</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token plain">func</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">take</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Use panic::catch_unwind to prevent Ruby process termination if the Rust code panics</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">match</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">panic</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">catch_unwind</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token class-name">AssertUnwindSafe</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">func</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=&gt;</span><span class="token plain"> data</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token plain">result </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token class-name">Ok</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                </span><span class="token class-name">Err</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">panic_info</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Convert panic info to a string message</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> panic_msg </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">if</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">s</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> panic_info</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">downcast_ref</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">::</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&amp;</span><span class="token lifetime-annotation symbol" style="color:hsl(5, 65%, 75%)">&#x27;static</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">str</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                        s</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">to_string</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">else</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">if</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">s</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> panic_info</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">downcast_ref</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">::</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token class-name">String</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                        s</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">clone</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">else</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                        </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;Unknown panic occurred in Rust code&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">to_string</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                    data</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token plain">result </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token class-name">Err</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">panic_msg</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token function" style="color:hsl(5, 65%, 65%)">null_mut</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Create a data structure to pass the function and receive the result</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">mut</span><span class="token plain"> data </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token class-name">CallbackData</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        func</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">func</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        result</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token class-name">None</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Release the GVL and call our function</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token function" style="color:hsl(5, 65%, 65%)">rb_thread_call_without_gvl</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token class-name">Some</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token function" style="color:hsl(5, 65%, 65%)">call_without_gvl</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">::</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token class-name">F</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">R</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token operator" style="color:hsl(220, 10%, 65%)">&amp;</span><span class="token keyword" style="color:hsl(200, 85%, 65%)">mut</span><span class="token plain"> data </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">as</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">*</span><span class="token keyword" style="color:hsl(200, 85%, 65%)">mut</span><span class="token plain"> _ </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">as</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">*</span><span class="token keyword" style="color:hsl(200, 85%, 65%)">mut</span><span class="token plain"> c_void</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token class-name">None</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain">  </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// No unblock function</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token function" style="color:hsl(5, 65%, 65%)">null_mut</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Extract the result or create an error if the function failed</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">match</span><span class="token plain"> data</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token plain">result </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token class-name">Some</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token class-name">Ok</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=&gt;</span><span class="token plain"> </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token class-name">Some</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token class-name">Err</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">panic_msg</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Convert the panic message to a Ruby RuntimeError</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> ruby </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"> </span><span class="token class-name">Ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">get_unchecked</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token class-name">Err</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token class-name">Error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">new</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">exception_runtime_error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">format!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;Rust panic in nogvl: {}&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> panic_msg</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token class-name">None</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// This should never happen if the callback runs, but handle it anyway</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> ruby </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"> </span><span class="token class-name">Ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">get_unchecked</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token class-name">Err</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token class-name">Error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">new</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">exception_runtime_error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">                </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;nogvl function was not executed&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-direct-rb-sys-works">How Direct rb-sys Works<a href="#how-direct-rb-sys-works" class="hash-link" aria-label="Direct link to How Direct rb-sys Works" title="Direct link to How Direct rb-sys Works">​</a></h3>
<p>When using rb-sys directly:</p>
<ol>
<li>You define C-compatible functions with the <code>extern &quot;C&quot;</code> calling convention</li>
<li>You manually convert between Ruby&#x27;s <code>VALUE</code> type and Rust types</li>
<li>You&#x27;re responsible for memory management and type safety</li>
<li>You must use the <code>#[no_mangle]</code> attribute on the initialization function so Ruby can find it</li>
<li>All interactions with Ruby data happen through raw pointers and unsafe code</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="higher-level-wrappers-magnus">Higher-level Wrappers (Magnus)<a href="#higher-level-wrappers-magnus" class="hash-link" aria-label="Direct link to Higher-level Wrappers (Magnus)" title="Direct link to Higher-level Wrappers (Magnus)">​</a></h2>
<p>Magnus provides a more ergonomic, Rust-like API on top of rb-sys. It handles many of the unsafe aspects of Ruby
integration for you.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-magnus">When to Use Magnus<a href="#when-to-use-magnus" class="hash-link" aria-label="Direct link to When to Use Magnus" title="Direct link to When to Use Magnus">​</a></h3>
<ul>
<li>For most standard Ruby extensions where ease of development is important</li>
<li>When you want to avoid writing unsafe code</li>
<li>When you want idiomatic Rust error handling</li>
<li>For extensions with complex type conversions</li>
<li>When working with Ruby classes and objects in an object-oriented way</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-simple-extension-with-magnus">Example: Simple Extension with Magnus<a href="#example-simple-extension-with-magnus" class="hash-link" aria-label="Direct link to Example: Simple Extension with Magnus" title="Direct link to Example: Simple Extension with Magnus">​</a></h3>
<p>Let&#x27;s look at a simple example using Magnus, based on real-world usage patterns:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:hsl(35, 15%, 88%);--prism-background-color:hsl(220, 18%, 10%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:hsl(35, 15%, 88%);background-color:hsl(220, 18%, 10%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token keyword" style="color:hsl(200, 85%, 65%)">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">magnus</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain">function</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">prelude</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token operator" style="color:hsl(220, 10%, 65%)">*</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">hello</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">subject</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">format!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;Hello from Rust, {subject}!&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token attribute attr-name" style="color:hsl(200, 85%, 70%)">#[magnus::init]</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">init</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">&amp;</span><span class="token class-name">Ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> module </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;StringUtils&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_singleton_method</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;hello&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">function!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">hello</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(5, 65%, 75%)">1</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Looking at a more complex example from a real-world project (lz4-flex-rb):</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:hsl(35, 15%, 88%);--prism-background-color:hsl(220, 18%, 10%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:hsl(35, 15%, 88%);background-color:hsl(220, 18%, 10%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token keyword" style="color:hsl(200, 85%, 65%)">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">magnus</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain">function</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">prelude</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token operator" style="color:hsl(220, 10%, 65%)">*</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">RModule</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token attribute attr-name" style="color:hsl(200, 85%, 70%)">#[magnus::init]</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">init</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">&amp;</span><span class="token class-name">Ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> module </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;Lz4Flex&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Define error classes</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> base_error </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;Error&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">magnus</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token namespace" style="opacity:0.7">exception</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">standard_error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> _ </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;EncodeError&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> base_error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> _ </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;DecodeError&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> base_error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Define methods</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_singleton_method</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;compress&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">function!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">compress</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(5, 65%, 75%)">1</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_singleton_method</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;decompress&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">function!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">decompress</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(5, 65%, 75%)">1</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Define aliases</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">singleton_class</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_alias</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;deflate&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;compress&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">singleton_class</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_alias</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;inflate&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;decompress&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Define nested module</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> varint_module </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;VarInt&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    varint_module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_singleton_method</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;compress&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">function!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">compress_varint</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(5, 65%, 75%)">1</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    varint_module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_singleton_method</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;decompress&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">function!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">decompress_varint</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(5, 65%, 75%)">1</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-magnus-works">How Magnus Works<a href="#how-magnus-works" class="hash-link" aria-label="Direct link to How Magnus Works" title="Direct link to How Magnus Works">​</a></h3>
<p>Magnus builds on top of rb-sys and provides:</p>
<ol>
<li>Automatic type conversions between Ruby and Rust</li>
<li>Rust-like error handling with <code>Result</code> types</li>
<li>Memory safety through RAII patterns</li>
<li>More ergonomic APIs for defining modules, classes, and methods</li>
<li>A more familiar development experience for Rust programmers</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-choose-each-approach">When to Choose Each Approach<a href="#when-to-choose-each-approach" class="hash-link" aria-label="Direct link to When to Choose Each Approach" title="Direct link to When to Choose Each Approach">​</a></h2>
<div class="codeComparison_cfCm"><div class="tabs-container tabsContainer_MFXm"><div role="tablist" aria-orientation="horizontal" class="tabList_TRJ7"><button role="tab" aria-selected="true" class="tabItem_hGfb tabItemActive_HPJJ">Approaches Comparison</button><button role="tab" aria-selected="false" class="tabItem_hGfb">When to Choose Each</button></div><div class="tabContent_vyUe"><div role="tabpanel" class="tabItem_Ymn6"><div class="codeBlock_bE1R"><div class="language-ruby codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:hsl(35, 15%, 88%);--prism-background-color:hsl(220, 18%, 10%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ruby codeBlock_bY9V thin-scrollbar" style="color:hsl(35, 15%, 88%);background-color:hsl(220, 18%, 10%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token command-literal command string" style="color:hsl(28, 60%, 70%)">``</span><span class="token plain">`</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">Direct rb</span><span class="token operator" style="color:hsl(220, 10%, 65%)">-</span><span class="token plain">sys</span><span class="token operator" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">✅ Maximum performance</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">✅ Low</span><span class="token operator" style="color:hsl(220, 10%, 65%)">-</span><span class="token plain">level Ruby </span><span class="token constant" style="color:hsl(5, 65%, 75%)">VM</span><span class="token plain"> control</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">✅ Fine</span><span class="token operator" style="color:hsl(220, 10%, 65%)">-</span><span class="token plain">grained </span><span class="token constant" style="color:hsl(5, 65%, 75%)">GVL</span><span class="token plain"> management</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">✅ Version</span><span class="token operator" style="color:hsl(220, 10%, 65%)">-</span><span class="token plain">specific behavior</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">❌ Lots of unsafe code</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">❌ Manual memory management</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">❌ More verbose type conversions</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">❌ Steeper learning curve</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token command-literal command string" style="color:hsl(28, 60%, 70%)">``</span><span class="token plain">`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="codeBlock_bE1R"><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:hsl(35, 15%, 88%);--prism-background-color:hsl(220, 18%, 10%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:hsl(35, 15%, 88%);background-color:hsl(220, 18%, 10%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">```</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token class-name">Magnus</span><span class="token plain"> </span><span class="token class-name">Wrapper</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">✅ </span><span class="token class-name">Higher</span><span class="token plain"> developer productivity</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">✅ </span><span class="token class-name">Better</span><span class="token plain"> memory safety</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">✅ </span><span class="token class-name">Ergonomic</span><span class="token plain"> </span><span class="token class-name">Ruby</span><span class="token plain"> class integration</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">✅ </span><span class="token class-name">Idiomatic</span><span class="token plain"> </span><span class="token class-name">Rust</span><span class="token plain"> error handling</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">❌ </span><span class="token class-name">Small</span><span class="token plain"> performance overhead</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">❌ </span><span class="token class-name">Less</span><span class="token plain"> control over </span><span class="token class-name">Ruby</span><span class="token plain"> internals</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">❌ </span><span class="token class-name">Slightly</span><span class="token plain"> higher learning curve </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">for</span><span class="token plain"> </span><span class="token class-name">Ruby</span><span class="token plain"> devs</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">❌ </span><span class="token class-name">Fewer</span><span class="token plain"> </span><span class="token constant" style="color:hsl(5, 65%, 75%)">GVL</span><span class="token plain"> optimization opportunities</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">```</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mixing-approaches">Mixing Approaches<a href="#mixing-approaches" class="hash-link" aria-label="Direct link to Mixing Approaches" title="Direct link to Mixing Approaches">​</a></h2>
<p>You can also mix the two approaches when appropriate. Magnus provides access to the underlying rb-sys functionality when
needed:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:hsl(35, 15%, 88%);--prism-background-color:hsl(220, 18%, 10%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:hsl(35, 15%, 88%);background-color:hsl(220, 18%, 10%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token keyword" style="color:hsl(200, 85%, 65%)">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">magnus</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain">function</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">prelude</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token operator" style="color:hsl(220, 10%, 65%)">*</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">use</span><span class="token plain"> rb_sys</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">std</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token namespace" style="opacity:0.7">os</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token namespace" style="opacity:0.7">raw</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token plain">c_char</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">high_level</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;High level&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">to_string</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">extern</span><span class="token plain"> </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;C&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">low_level</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">_</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">rb_sys</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">rb_sys</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Direct rb-sys implementation</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> c_string </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">std</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token namespace" style="opacity:0.7">ffi</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token class-name">CString</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">new</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;Low level&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">unwrap</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token namespace" style="opacity:0.7">rb_sys</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">rb_str_new_cstr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">c_string</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">as_ptr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token attribute attr-name" style="color:hsl(200, 85%, 70%)">#[magnus::init]</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">init</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">&amp;</span><span class="token class-name">Ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> module </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;MixedExample&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Use Magnus for most things</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_singleton_method</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;high_level&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">function!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">high_level</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(5, 65%, 75%)">0</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Use rb-sys directly for special cases</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">rb_sys</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">rb_define_module_function</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">as_raw</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">cstr!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;low_level&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token class-name">Some</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">low_level </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">as</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">extern</span><span class="token plain"> </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;C&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token namespace" style="opacity:0.7">rb_sys</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">rb_sys</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token number" style="color:hsl(5, 65%, 75%)">0</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Helper macro for C strings</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token macro property" style="color:hsl(5, 65%, 75%)">macro_rules!</span><span class="token plain"> cstr </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token variable" style="color:hsl(5, 65%, 75%)">$s</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token fragment-specifier punctuation" style="color:hsl(220, 10%, 65%)">expr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">concat!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token variable" style="color:hsl(5, 65%, 75%)">$s</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;\0&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">as_ptr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">as</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">*</span><span class="token keyword" style="color:hsl(200, 85%, 65%)">const</span><span class="token plain"> c_char</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="enabling-rb-sys-feature-in-magnus">Enabling rb-sys Feature in Magnus<a href="#enabling-rb-sys-feature-in-magnus" class="hash-link" aria-label="Direct link to Enabling rb-sys Feature in Magnus" title="Direct link to Enabling rb-sys Feature in Magnus">​</a></h3>
<p>To access rb-sys through Magnus, enable the <code>rb-sys</code> feature:</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:hsl(35, 15%, 88%);--prism-background-color:hsl(220, 18%, 10%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:hsl(35, 15%, 88%);background-color:hsl(220, 18%, 10%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"># Cargo.toml</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">[dependencies]</span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">magnus = { version = &quot;0.7&quot;, features = [&quot;rb-sys&quot;] }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="common-mixing-patterns">Common Mixing Patterns<a href="#common-mixing-patterns" class="hash-link" aria-label="Direct link to Common Mixing Patterns" title="Direct link to Common Mixing Patterns">​</a></h3>
<ol>
<li>
<p><strong>Use Magnus for most functionality, rb-sys for specific optimizations</strong>:</p>
<ul>
<li>Define your public API using Magnus for safety and ease</li>
<li>Drop down to rb-sys in critical performance paths, especially when using <code>nogvl</code></li>
</ul>
</li>
<li>
<p><strong>Use rb-sys for core functionality, Magnus for complex conversions</strong>:</p>
<ul>
<li>Build core functionality with rb-sys for maximum control</li>
<li>Use Magnus for handling complex Ruby objects or collections</li>
</ul>
</li>
<li>
<p><strong>Start with Magnus, optimize with rb-sys over time</strong>:</p>
<ul>
<li>Begin development with Magnus for rapid progress</li>
<li>Profile your code and replace hot paths with direct rb-sys</li>
</ul>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="real-world-examples">Real-World Examples<a href="#real-world-examples" class="hash-link" aria-label="Direct link to Real-World Examples" title="Direct link to Real-World Examples">​</a></h2>
<p>Let&#x27;s look at how real projects decide between these approaches:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="blake3-ruby-direct-rb-sys">Blake3-Ruby (Direct rb-sys)<a href="#blake3-ruby-direct-rb-sys" class="hash-link" aria-label="Direct link to Blake3-Ruby (Direct rb-sys)" title="Direct link to Blake3-Ruby (Direct rb-sys)">​</a></h3>
<p>Blake3-Ruby is a cryptographic hashing library that uses direct rb-sys to achieve maximum performance:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:hsl(35, 15%, 88%);--prism-background-color:hsl(220, 18%, 10%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:hsl(35, 15%, 88%);background-color:hsl(220, 18%, 10%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Based on blake3-ruby</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">rb_sys</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    rb_define_module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> rb_define_module_function</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> rb_string_value_cstr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    rb_str_new_cstr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token attribute attr-name" style="color:hsl(200, 85%, 70%)">#[no_mangle]</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">pub</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">extern</span><span class="token plain"> </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;C&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">Init_blake3_ext</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Create module and class hierarchy</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> digest_module </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">/* ... */</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> blake3_class </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">/* ... */</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Define methods directly using rb-sys for maximum performance</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token function" style="color:hsl(5, 65%, 65%)">rb_define_module_function</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            blake3_class</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">cstr!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;digest&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token class-name">Some</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">rb_blake3_digest </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">as</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">extern</span><span class="token plain"> </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;C&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">            </span><span class="token number" style="color:hsl(5, 65%, 75%)">1</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// More method definitions...</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">extern</span><span class="token plain"> </span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;C&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">rb_blake3_digest</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">_klass</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> string</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:hsl(5, 65%, 75%)">VALUE</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Extract data from Ruby VALUE</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> data_ptr </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token function" style="color:hsl(5, 65%, 65%)">rb_string_value_cstr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&amp;</span><span class="token plain">string</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> data_len </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">/* ... */</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Release GVL for CPU-intensive operation</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> hash </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token function" style="color:hsl(5, 65%, 65%)">nogvl</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token closure-params closure-punctuation punctuation" style="color:hsl(220, 10%, 65%)">|</span><span class="token closure-params closure-punctuation punctuation" style="color:hsl(220, 10%, 65%)">|</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">blake3</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">hash</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">/* ... */</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Return result as Ruby string</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token function" style="color:hsl(5, 65%, 65%)">rb_str_new_cstr</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">/* ... */</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lz4-flex-rb-mixed-approach">LZ4-Flex-RB (Mixed Approach)<a href="#lz4-flex-rb-mixed-approach" class="hash-link" aria-label="Direct link to LZ4-Flex-RB (Mixed Approach)" title="Direct link to LZ4-Flex-RB (Mixed Approach)">​</a></h3>
<p>The LZ4-Flex-RB gem demonstrates a more sophisticated approach mixing Magnus with direct rb-sys calls:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:hsl(35, 15%, 88%);--prism-background-color:hsl(220, 18%, 10%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:hsl(35, 15%, 88%);background-color:hsl(220, 18%, 10%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Based on lz4-flex-rb</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">magnus</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain">function</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">prelude</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token operator" style="color:hsl(220, 10%, 65%)">*</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">RModule</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">rb_sys</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain">rb_str_locktmp</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> rb_str_unlocktmp</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> rb_thread_call_without_gvl</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token attribute attr-name" style="color:hsl(200, 85%, 70%)">#[magnus::init]</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">init</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">&amp;</span><span class="token class-name">Ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> module </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> ruby</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;Lz4Flex&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// High-level API using Magnus</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_singleton_method</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;compress&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">function!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">compress</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(5, 65%, 75%)">1</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    module</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">define_singleton_method</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token string" style="color:hsl(28, 60%, 70%)">&quot;decompress&quot;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token macro property" style="color:hsl(5, 65%, 75%)">function!</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">decompress</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(5, 65%, 75%)">1</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Functions that mix high-level Magnus with low-level rb-sys</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">compress</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">input</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token class-name">LockedRString</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&lt;</span><span class="token class-name">RString</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> bufsize </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token function" style="color:hsl(5, 65%, 65%)">get_maximum_output_size</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">input</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">len</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">mut</span><span class="token plain"> output </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token class-name">RStringMut</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">buf_new</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">bufsize</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Use nogvl_if_large to release GVL for large inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">let</span><span class="token plain"> outsize </span><span class="token operator" style="color:hsl(220, 10%, 65%)">=</span><span class="token plain"> </span><span class="token function" style="color:hsl(5, 65%, 65%)">nogvl_if_large</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">input</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">len</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> </span><span class="token closure-params closure-punctuation punctuation" style="color:hsl(220, 10%, 65%)">|</span><span class="token closure-params closure-punctuation punctuation" style="color:hsl(220, 10%, 65%)">|</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token namespace" style="opacity:0.7">lz4_flex</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token namespace" style="opacity:0.7">block</span><span class="token namespace punctuation" style="opacity:0.7;color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">compress_into</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">input</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">as_slice</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> output</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">as_mut_slice</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">map_err</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token closure-params closure-punctuation punctuation" style="color:hsl(220, 10%, 65%)">|</span><span class="token closure-params">e</span><span class="token closure-params closure-punctuation punctuation" style="color:hsl(220, 10%, 65%)">|</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">::</span><span class="token function" style="color:hsl(5, 65%, 65%)">new</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token function" style="color:hsl(5, 65%, 65%)">encode_error_class</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">to_string</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token operator" style="color:hsl(220, 10%, 65%)">?</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    output</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">set_len</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">outsize</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">output</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">into_inner</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Helper for locked RString (uses rb-sys directly)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">struct</span><span class="token plain"> </span><span class="token type-definition class-name">LockedRString</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token class-name">RString</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">impl</span><span class="token plain"> </span><span class="token class-name">LockedRString</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">new</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">string</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">:</span><span class="token plain"> </span><span class="token class-name">RString</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">Self</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"> </span><span class="token function" style="color:hsl(5, 65%, 65%)">rb_str_locktmp</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">string</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">as_raw</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">Self</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token plain">string</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">as_slice</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&amp;</span><span class="token keyword" style="color:hsl(200, 85%, 65%)">self</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">-&gt;</span><span class="token plain"> </span><span class="token operator" style="color:hsl(220, 10%, 65%)">&amp;</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">[</span><span class="token keyword" style="color:hsl(200, 85%, 65%)">u8</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token comment" style="color:hsl(220, 10%, 50%);font-style:italic">// Implementation using rb-sys functions</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(200, 85%, 65%)">impl</span><span class="token plain"> </span><span class="token class-name">Drop</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">for</span><span class="token plain"> </span><span class="token class-name">LockedRString</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:hsl(5, 65%, 65%)">drop</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token operator" style="color:hsl(220, 10%, 65%)">&amp;</span><span class="token keyword" style="color:hsl(200, 85%, 65%)">mut</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">self</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(200, 85%, 65%)">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">{</span><span class="token plain"> </span><span class="token function" style="color:hsl(5, 65%, 65%)">rb_str_unlocktmp</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token keyword" style="color:hsl(200, 85%, 65%)">self</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token number" style="color:hsl(5, 65%, 75%)">0</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">.</span><span class="token function" style="color:hsl(5, 65%, 65%)">as_raw</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">(</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain">    </span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(35, 15%, 88%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(220, 10%, 65%)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article></div></div></div></div></main></div></div></main></div><footer class="footer"><div class="footer__container"><div class="footer__links"><div class="col"><div class="footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started">Getting Started</a></li></ul></div></div><div class="col"><div class="footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://join.slack.com/t/oxidize-rb/shared_invite/zt-16zv5tqte-Vi7WfzxCesdo2TqF_RYBCw" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_gvfU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/oxidize-rb/rb-sys/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_gvfU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="col"><div class="footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/oxidize-rb/rb-sys" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_gvfU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="col"><div class="footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"></ul></div></div></div><div class="footer__copyright">Copyright © 2025 rb-sys</div></div></footer></div>
</body>
</html>