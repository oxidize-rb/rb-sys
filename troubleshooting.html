<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Troubleshooting Guide - The Ruby on Rust Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="A comprehensive guide to building Ruby extensions with Rust using rb-sys">
        <meta name="keywords" content="ruby, rust, ffi, bindings, rb-sys, ruby on rust">
        <meta name="author" content="">
        
        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website">
        <meta property="og:url" content="">
        <meta property="og:title" content="Troubleshooting Guide - The Ruby on Rust Book">
        <meta property="og:description" content="A comprehensive guide to building Ruby extensions with Rust using rb-sys">
        
        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="">
        <meta property="twitter:title" content="Troubleshooting Guide - The Ruby on Rust Book">
        <meta property="twitter:description" content="A comprehensive guide to building Ruby extensions with Rust using rb-sys">
        
        <!-- Canonical URL -->
        <link rel="canonical" href="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/css/custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Ruby on Rust Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/oxidize-rb/rb-sys" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="troubleshooting-guide"><a class="header" href="#troubleshooting-guide">Troubleshooting Guide</a></h1>
<p>This chapter provides solutions to common issues encountered when developing Ruby extensions with rb-sys and magnus.</p>
<h2 id="getting-started-issues"><a class="header" href="#getting-started-issues">Getting Started Issues</a></h2>
<h3 id="installation-problems"><a class="header" href="#installation-problems">Installation Problems</a></h3>
<h4 id="missing-libclang"><a class="header" href="#missing-libclang">Missing libclang</a></h4>
<p><strong>Problem</strong>: Build fails with errors related to missing libclang:</p>
<pre><code>error: failed to run custom build command for `bindgen v0.64.0`
...
could not find libclang: "couldn't find any valid shared libraries matching: ['libclang.so', ...]"
</code></pre>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Add libclang to your Gemfile:</p>
<pre><code class="language-ruby">gem "libclang", "~&gt; 14.0"
</code></pre>
</li>
<li>
<p>On Linux, install libclang through your package manager:</p>
<pre><code class="language-bash"># Debian/Ubuntu
apt-get install libclang-dev

# Fedora/RHEL
dnf install clang-devel
</code></pre>
</li>
<li>
<p>On macOS:</p>
<pre><code class="language-bash">brew install llvm
export LLVM_CONFIG=$(brew --prefix llvm)/bin/llvm-config
</code></pre>
</li>
</ol>
<h4 id="ruby-headers-not-found"><a class="header" href="#ruby-headers-not-found">Ruby Headers Not Found</a></h4>
<p><strong>Problem</strong>: Build fails with error about missing Ruby headers:</p>
<pre><code>error: failed to run custom build command for `rb-sys v0.9.78`
...
fatal error: ruby.h: No such file or directory
</code></pre>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Ensure you have Ruby development headers installed:</p>
<pre><code class="language-bash"># Debian/Ubuntu
apt-get install ruby-dev

# Fedora/RHEL
dnf install ruby-devel
</code></pre>
</li>
<li>
<p>If using rbenv/rvm/asdf, make sure you've installed the development headers:</p>
<pre><code class="language-bash"># For rbenv
RUBY_CONFIGURE_OPTS=--enable-shared rbenv install 3.0.0

# For rvm
rvm install 3.0.0 --with-openssl-dir=$(brew --prefix openssl)
</code></pre>
</li>
<li>
<p>Check your build.rs file includes:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let _ = rb_sys_env::activate()?;
<span class="boring">}</span></code></pre></pre>
</li>
</ol>
<h2 id="compilation-issues"><a class="header" href="#compilation-issues">Compilation Issues</a></h2>
<h3 id="cargo-build-errors"><a class="header" href="#cargo-build-errors">Cargo Build Errors</a></h3>
<h4 id="version-compatibility"><a class="header" href="#version-compatibility">Version Compatibility</a></h4>
<p><strong>Problem</strong>: Build fails with version incompatibility errors:</p>
<pre><code>error: failed to select a version for the requirement `rb-sys = "^0.9.80"`
</code></pre>
<p><strong>Solution</strong>:</p>
<ol>
<li>
<p>Check your magnus and rb-sys versions are compatible:</p>
<pre><code class="language-toml"># Cargo.toml
[dependencies]
magnus = "0.7"     # Check latest compatible version
rb-sys = "0.9.80"  # Check latest version
</code></pre>
</li>
<li>
<p>Update rb-sys in your Gemfile:</p>
<pre><code class="language-ruby">gem 'rb_sys', '~&gt; 0.9.80'
</code></pre>
</li>
</ol>
<h4 id="linking-issues"><a class="header" href="#linking-issues">Linking Issues</a></h4>
<p><strong>Problem</strong>: Build fails with undefined references:</p>
<pre><code>error: linking with `cc` failed: exit status: 1
...
undefined reference to `rb_define_module`
</code></pre>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Ensure your build.rs is correctly set up:</p>
<pre><pre class="playground"><code class="language-rust">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
    let _ = rb_sys_env::activate()?;
    Ok(())
}</code></pre></pre>
</li>
<li>
<p>Verify Ruby version compatibility with rb-sys version</p>
</li>
<li>
<p>Ensure you have Ruby development headers installed</p>
</li>
</ol>
<h4 id="build-script-errors"><a class="header" href="#build-script-errors">Build Script Errors</a></h4>
<p><strong>Problem</strong>: Build script execution fails:</p>
<pre><code>error: failed to run custom build command for `rb-sys v0.9.78`
</code></pre>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Check permissions and environment variables:</p>
<pre><code class="language-bash"># Set necessary environment variables
export RUBY_ROOT=$(rbenv prefix)
export PATH=$RUBY_ROOT/bin:$PATH
</code></pre>
</li>
<li>
<p>If using Docker, ensure the build environment has Ruby installed and configured</p>
</li>
</ol>
<h2 id="runtime-issues"><a class="header" href="#runtime-issues">Runtime Issues</a></h2>
<h3 id="ruby-object-management"><a class="header" href="#ruby-object-management">Ruby Object Management</a></h3>
<h4 id="segmentation-faults"><a class="header" href="#segmentation-faults">Segmentation Faults</a></h4>
<p><strong>Problem</strong>: Ruby process crashes with a segmentation fault:</p>
<pre><code>[BUG] Segmentation fault
ruby 3.0.0p0 (2020-12-25 revision 95aff21468) [x86_64-linux]
</code></pre>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Ensure Ruby objects are correctly protected from garbage collection:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Using Magnus (preferred)
let obj = RObject::new(ruby, ruby.class_object())?;

// With raw rb-sys
unsafe {
    let obj = rb_sys::rb_obj_alloc(rb_sys::rb_cObject);
    rb_sys::rb_gc_register_mark_object(obj);
    // Use obj...
    rb_sys::rb_gc_unregister_mark_object(obj);
}
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p>Check all pointers are valid before dereferencing</p>
</li>
<li>
<p>Use TypedData with proper mark implementation</p>
</li>
</ol>
<h4 id="borrowmuterror-panics"><a class="header" href="#borrowmuterror-panics">BorrowMutError Panics</a></h4>
<p><strong>Problem</strong>: Your extension panics with a "already borrowed" error when using RefCell:</p>
<pre><code>thread '&lt;unnamed&gt;' panicked at 'already borrowed: BorrowMutError'
</code></pre>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Fix borrow order - always complete immutable borrows before mutable borrows:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// WRONG - causes BorrowMutError
if self.0.borrow().value &gt; 10 {
    self.0.borrow_mut().value = 0; // Error: still borrowed from the if condition
}

// RIGHT - copy values then borrow mutably
let current = self.0.borrow().value; // Complete this borrow
if current &gt; 10 {
    self.0.borrow_mut().value = 0; // Now safe to borrow mutably
}
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p>Consider restructuring your data to avoid nested borrows</p>
</li>
<li>
<p>Use separate methods for reading and writing</p>
</li>
</ol>
<h3 id="rubyrust-type-conversion-issues"><a class="header" href="#rubyrust-type-conversion-issues">Ruby/Rust Type Conversion Issues</a></h3>
<h4 id="unexpected-nil-values"><a class="header" href="#unexpected-nil-values">Unexpected Nil Values</a></h4>
<p><strong>Problem</strong>: Your extension crashes when encountering nil:</p>
<pre><code>TypeError: no implicit conversion of nil into String
</code></pre>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Always check for nil before conversion:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn process_string(val: Value) -&gt; Result&lt;String, Error&gt; {
    if val.is_nil() {
        // Handle nil case
        return Ok("default".to_string());
    }

    let string = RString::try_convert(val)?;
    Ok(string.to_string()?)
}
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p>Use Option for conversions that might return nil:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let maybe_string: Option&lt;String&gt; = val.try_convert()?;
match maybe_string {
    Some(s) =&gt; process_string(s),
    None =&gt; handle_nil_case(),
}
<span class="boring">}</span></code></pre></pre>
</li>
</ol>
<h4 id="type-errors"><a class="header" href="#type-errors">Type Errors</a></h4>
<p><strong>Problem</strong>: Function fails with type mismatch errors:</p>
<pre><code>TypeError: wrong argument type Integer (expected String)
</code></pre>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Add explicit type checking before conversion:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn process_value(ruby: &amp;Ruby, val: Value) -&gt; Result&lt;(), Error&gt; {
    if !val.is_kind_of(ruby, ruby.class_object::&lt;RString&gt;()?) {
        return Err(Error::new(
            ruby.exception_type_error(),
            format!("Expected String, got {}", val.class().name())
        ));
    }

    let string = RString::try_convert(val)?;
    // Process string...
    Ok(())
}
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p>Use try_convert with proper error handling:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>match RString::try_convert(val) {
    Ok(string) =&gt; {
        // Process string...
        Ok(())
    },
    Err(_) =&gt; {
        Err(Error::new(
            ruby.exception_type_error(),
            "Expected String argument"
        ))
    }
}
<span class="boring">}</span></code></pre></pre>
</li>
</ol>
<h2 id="memory-and-performance-issues"><a class="header" href="#memory-and-performance-issues">Memory and Performance Issues</a></h2>
<h3 id="memory-leaks"><a class="header" href="#memory-leaks">Memory Leaks</a></h3>
<p><strong>Problem</strong>: Your extension gradually consumes more memory over time.</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Ensure Ruby objects are properly released when using raw rb-sys:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>unsafe {
    // Register the object to protect it from GC
    rb_sys::rb_gc_register_mark_object(obj);

    // Use the object...

    // Unregister when done (important!)
    rb_sys::rb_gc_unregister_mark_object(obj);
}
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p>Implement proper mark methods for TypedData:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(TypedData)]
#[magnus(class = "MyClass", free_immediately, mark)]
struct MyObject {
    references: Vec&lt;Value&gt;,
}

impl DataTypeFunctions for MyObject {
    fn mark(&amp;self, marker: &amp;Marker) {
        for reference in &amp;self.references {
            marker.mark(*reference);
        }
    }
}
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p>Use ruby_memcheck to detect leaks (see <a href="debugging.html">Debugging chapter</a>)</p>
</li>
</ol>
<h3 id="global-vm-lock-gvl-issues"><a class="header" href="#global-vm-lock-gvl-issues">Global VM Lock (GVL) Issues</a></h3>
<p><strong>Problem</strong>: CPU-intensive operations block the Ruby VM.</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Release the GVL during CPU-intensive work:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use rb_sys::rb_thread_call_without_gvl;
use std::{ffi::c_void, ptr::null_mut};

pub fn nogvl&lt;F, R&gt;(func: F) -&gt; R
where
    F: FnOnce() -&gt; R,
    R: Send + 'static,
{
    struct CallbackData&lt;F, R&gt; {
        func: Option&lt;F&gt;,
        result: Option&lt;R&gt;,
    }

    extern "C" fn callback&lt;F, R&gt;(data: *mut c_void) -&gt; *mut c_void
    where
        F: FnOnce() -&gt; R,
        R: Send + 'static,
    {
        let data = unsafe { &amp;mut *(data as *mut CallbackData&lt;F, R&gt;) };
        if let Some(func) = data.func.take() {
            data.result = Some(func());
        }
        null_mut()
    }

    let mut data = CallbackData {
        func: Some(func),
        result: None,
    };

    unsafe {
        rb_thread_call_without_gvl(
            Some(callback::&lt;F, R&gt;),
            &amp;mut data as *mut _ as *mut c_void,
            None,
            null_mut(),
        );
    }

    data.result.unwrap()
}
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p>Only release the GVL for operations that don't interact with Ruby objects:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Safe to run without GVL - pure computation
let result = nogvl(|| {
    compute_intensive_function(input_data)
});

// NOT safe to run without GVL - interacts with Ruby
// let result = nogvl(|| {
//     ruby_object.some_method() // WRONG - will crash
// });
<span class="boring">}</span></code></pre></pre>
</li>
</ol>
<h2 id="cross-platform-issues"><a class="header" href="#cross-platform-issues">Cross-Platform Issues</a></h2>
<h3 id="ruby-head-compatibility-issues"><a class="header" href="#ruby-head-compatibility-issues">Ruby-Head Compatibility Issues</a></h3>
<p><strong>Problem</strong>: Gems don't work with <code>ruby-head</code> or development versions of Ruby.</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Always publish a source gem alongside platform-specific gems:</p>
<pre><code class="language-ruby"># In your release workflow, build both platform-specific and source gems
# The source gem allows ruby-head users to compile against their exact version
bundle exec rake build  # For source gem
bundle exec rake native # For platform-specific gems
</code></pre>
</li>
<li>
<p>For users, install the gem with compilation enabled:</p>
<pre><code class="language-bash">gem install my_gem --platform=ruby
</code></pre>
</li>
<li>
<p>For gem maintainers, update your CI to test against ruby-head:</p>
<pre><code class="language-yaml"># .github/workflows/test.yml
strategy:
  matrix:
    ruby: ["3.1", "3.2", "3.3", "head"]
</code></pre>
</li>
</ol>
<h3 id="platform-specific-build-problems"><a class="header" href="#platform-specific-build-problems">Platform-Specific Build Problems</a></h3>
<h4 id="windows-issues"><a class="header" href="#windows-issues">Windows Issues</a></h4>
<p><strong>Problem</strong>: Build fails on Windows with linking errors.</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Ensure you have the correct toolchain installed:</p>
<pre><code class="language-bash">rustup target add x86_64-pc-windows-msvc
</code></pre>
</li>
<li>
<p>Add platform-specific configuration in Cargo.toml:</p>
<pre><code class="language-toml">[target.'cfg(windows)'.dependencies]
winapi = { version = "0.3", features = ["everything"] }
</code></pre>
</li>
<li>
<p>Use conditional compilation for platform-specific code:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[cfg(windows)]
fn platform_specific() {
    // Windows-specific code
}

#[cfg(unix)]
fn platform_specific() {
    // Unix-specific code
}
<span class="boring">}</span></code></pre></pre>
</li>
</ol>
<h4 id="macos-issues"><a class="header" href="#macos-issues">macOS Issues</a></h4>
<p><strong>Problem</strong>: Build fails on macOS with architecture or linking issues.</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Specify architecture when needed:</p>
<pre><code class="language-bash">RUBY_CONFIGURE_OPTS="--with-arch=x86_64,arm64" rbenv install 3.0.0
</code></pre>
</li>
<li>
<p>Fix linking for universal binaries:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// build.rs
#[cfg(target_os = "macos")]
{
    println!("cargo:rustc-link-arg=-arch");
    println!("cargo:rustc-link-arg=arm64");
    println!("cargo:rustc-link-arg=-arch");
    println!("cargo:rustc-link-arg=x86_64");
}
<span class="boring">}</span></code></pre></pre>
</li>
</ol>
<h3 id="cargotoml-configuration-issues"><a class="header" href="#cargotoml-configuration-issues">Cargo.toml Configuration Issues</a></h3>
<h4 id="feature-flag-problems"><a class="header" href="#feature-flag-problems">Feature Flag Problems</a></h4>
<p><strong>Problem</strong>: Build fails because of conflicting or missing feature flags.</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Check for feature flag issues in dependencies:</p>
<pre><code class="language-toml">[dependencies]
magnus = { version = "0.7", features = ["rb-sys"] }
rb-sys = { version = "0.9.80", features = ["stable-api"] }
</code></pre>
</li>
<li>
<p>Use debug prints in build.rs to check feature detection:</p>
<pre><pre class="playground"><code class="language-rust">fn main() {
    println!("cargo:warning=Ruby version: {}", rb_sys_env::ruby_major_version());

    #[cfg(feature = "some-feature")]
    println!("cargo:warning=some-feature is enabled");
}</code></pre></pre>
</li>
</ol>
<h2 id="ruby-integration-issues"><a class="header" href="#ruby-integration-issues">Ruby Integration Issues</a></h2>
<h3 id="method-definition-problems"><a class="header" href="#method-definition-problems">Method Definition Problems</a></h3>
<p><strong>Problem</strong>: Ruby method definitions don't work as expected.</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Check method arity and macro usage:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// For instance methods (that use &amp;self)
class.define_method("instance_method", method!(MyClass::instance_method, 1))?;

// For class/module methods (no &amp;self)
class.define_singleton_method("class_method", function!(class_method, 1))?;
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p>Verify method signatures:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Instance method
fn instance_method(&amp;self, arg: Value) -&gt; Result&lt;Value, Error&gt; {
    // Method implementation...
}

// Class method
fn class_method(arg: Value) -&gt; Result&lt;Value, Error&gt; {
    // Method implementation...
}

// Method with ruby
fn method_with_ruby(ruby: &amp;Ruby, arg: Value) -&gt; Result&lt;Value, Error&gt; {
    // Method implementation...
}
<span class="boring">}</span></code></pre></pre>
</li>
</ol>
<h3 id="moduleclass-hierarchy-issues"><a class="header" href="#moduleclass-hierarchy-issues">Module/Class Hierarchy Issues</a></h3>
<p><strong>Problem</strong>: Ruby modules or classes aren't defined correctly.</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Check the correct nesting of defines:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Define a module and a nested class
let module = ruby.define_module("MyModule")?;
let class = module.define_class("MyClass", ruby.class_object())?;

// Define a nested module
let nested = module.define_module("Nested")?;
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p>Verify class inheritance:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Get the correct superclass
let superclass = ruby.class_object::&lt;RObject&gt;()?;

// Define a class with the superclass
let class = ruby.define_class("MyClass", superclass)?;
<span class="boring">}</span></code></pre></pre>
</li>
</ol>
<h2 id="debugging-ruby-exceptions"><a class="header" href="#debugging-ruby-exceptions">Debugging Ruby Exceptions</a></h2>
<h3 id="custom-exception-handling"><a class="header" href="#custom-exception-handling">Custom Exception Handling</a></h3>
<p><strong>Problem</strong>: Ruby exceptions aren't properly caught or raised.</p>
<p><strong>Solutions</strong>:</p>
<ol>
<li>
<p>Define and use custom exception classes:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn init(ruby: &amp;Ruby) -&gt; Result&lt;(), Error&gt; {
    let module = ruby.define_module("MyModule")?;

    // Define custom exceptions
    let std_error = ruby.exception_standard_error();
    let custom_error = module.define_class("CustomError", std_error)?;

    Ok(())
}

fn raise_custom_error(ruby: &amp;Ruby) -&gt; Result&lt;(), Error&gt; {
    Err(Error::new(
        ruby.class_path_to_value("MyModule::CustomError"),
        "Something went wrong"
    ))
}
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p>Catch specific exception types:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn handle_exceptions(ruby: &amp;Ruby, val: Value) -&gt; Result&lt;Value, Error&gt; {
    let result = val.funcall(ruby, "may_raise", ());

    match result {
        Ok(v) =&gt; Ok(v),
        Err(e) if e.is_kind_of(ruby, ruby.exception_zero_div_error()) =&gt; {
            // Handle division by zero
            Ok(ruby.integer_from_i64(0))
        },
        Err(e) =&gt; Err(e), // Re-raise other exceptions
    }
}
<span class="boring">}</span></code></pre></pre>
</li>
</ol>
<h2 id="additional-resources"><a class="header" href="#additional-resources">Additional Resources</a></h2>
<ul>
<li><strong>Official Documentation</strong>: <a href="https://github.com/oxidize-rb/rb-sys">rb-sys</a> and
<a href="https://github.com/matsadler/magnus">magnus</a></li>
<li><strong>Examples</strong>: Check the <a href="https://github.com/oxidize-rb/rb-sys/tree/main/examples">examples directory</a> in rb-sys</li>
<li><strong>Community Support</strong>:
<a href="https://join.slack.com/t/oxidize-rb/shared_invite/zt-16zv5tqte-Vi7WfzxCesdo2TqF_RYBCw">Join the Slack channel</a></li>
<li><strong>Further Reading</strong>: See the <a href="debugging.html">Debugging chapter</a> for more detailed debugging techniques</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" style="margin-bottom: 0;" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="debugging.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="api-reference/rb-sys-features.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                    
                    <div class="footer-note" style="margin: 3rem 0 0 0; padding: 2rem; font-size: 1.1rem; color: #555; border-top: 1px solid #ddd; display: flex; justify-content: center; align-items: center; font-family: inherit;">
                        <div style="max-width: 800px; text-align: center; line-height: 1.6;">
                            This documentation was created with assistance from an LLM.<br>
                            If you spot any issues, please <a href="https://github.com/oxidize-rb/rb-sys/issues" style="color: #3184a8; text-decoration: none; font-weight: bold;">submit a fix or report it</a>.<br>
                            We appreciate your help in improving these docs!
                        </div>
                    </div>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="debugging.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="api-reference/rb-sys-features.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="theme/js/custom.js"></script>


    </div>
    </body>
</html>
