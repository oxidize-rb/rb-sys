"use strict";(self.webpackChunkdocsite=self.webpackChunkdocsite||[]).push([[3340],{209:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>o,default:()=>x,frontMatter:()=>l,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"deployment","title":"Deployment & Distribution","description":"This guide covers how to distribute your Rust-based Ruby gem to users on different platforms by cross-compiling pre-compiled (\\"fat\\") gems.","source":"@site/docs/deployment.mdx","sourceDirName":".","slug":"/deployment","permalink":"/docs/deployment","draft":false,"unlisted":false,"editUrl":"https://github.com/oxidize-rb/rb-sys/tree/main/docsite/docs/deployment.mdx","tags":[],"version":"current","lastUpdatedBy":"Ian Ker-Seymer","lastUpdatedAt":1764872846000,"frontMatter":{"id":"deployment","title":"Deployment & Distribution"},"sidebar":"docsSidebar","previous":{"title":"The Build Process","permalink":"/docs/build-process"},"next":{"title":"Crate `rb-sys`","permalink":"/docs/api-reference/rb-sys-features"}}');var i=n(4848),r=n(8453);const l={id:"deployment",title:"Deployment & Distribution"},o="Deployment & Distribution",d={},c=[{value:"The Native Gem Problem",id:"the-native-gem-problem",level:2},{value:"Platform Support",id:"platform-support",level:2},{value:"Platform Matrix",id:"platform-matrix",level:3},{value:"Cross-Compilation with <code>rb-sys-dock</code>",id:"cross-compilation-with-rb-sys-dock",level:2},{value:"Setup",id:"setup",level:3},{value:"Usage",id:"usage",level:3},{value:"CI/CD Release Workflow",id:"cicd-release-workflow",level:2}];function a(e){const t={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"deployment--distribution",children:"Deployment & Distribution"})}),"\n",(0,i.jsx)(t.p,{children:'This guide covers how to distribute your Rust-based Ruby gem to users on different platforms by cross-compiling pre-compiled ("fat") gems.'}),"\n",(0,i.jsx)(t.h2,{id:"the-native-gem-problem",children:"The Native Gem Problem"}),"\n",(0,i.jsx)(t.p,{children:'Shipping native Ruby gems without pre-compiled binaries forces users to have the Rust toolchain installed. The standard solution is to provide pre-compiled binaries for common platforms, often called "fat gems," bundling compiled extensions to work out-of-the-box.'}),"\n",(0,i.jsx)(t.h2,{id:"platform-support",children:"Platform Support"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"rb-sys"})," identifies target platforms using standardized strings for operating systems and CPU architectures."]}),"\n",(0,i.jsx)(t.h3,{id:"platform-matrix",children:"Platform Matrix"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Platform String"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Description"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Docker Image"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"x86_64-linux"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"64-bit Linux (glibc)"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"rbsys/x86_64-linux"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"x86_64-linux-musl"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"64-bit Linux (musl)"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"rbsys/x86_64-linux-musl"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"aarch64-linux"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"64-bit Linux on ARM"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"rbsys/aarch64-linux"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"x86_64-darwin"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"64-bit macOS on Intel"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"rbsys/x86_64-darwin"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"arm64-darwin"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"64-bit macOS on Apple Silicon"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"rbsys/arm64-darwin"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"x64-mingw-ucrt"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"64-bit Windows (UCRT)"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"rbsys/x64-mingw-ucrt"})})]})]})]}),"\n",(0,i.jsxs)(t.h2,{id:"cross-compilation-with-rb-sys-dock",children:["Cross-Compilation with ",(0,i.jsx)(t.code,{children:"rb-sys-dock"})]}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"rb-sys-dock"})," tool simplifies cross-compilation using Docker containers with pre-installed toolchains."]}),"\n",(0,i.jsx)(t.h3,{id:"setup",children:"Setup"}),"\n",(0,i.jsxs)(t.p,{children:["Enable cross-compilation by setting ",(0,i.jsx)(t.code,{children:"ext.cross_compile = true"})," in your ",(0,i.jsx)(t.code,{children:"Rakefile"}),"'s ",(0,i.jsx)(t.code,{children:"RbSys::ExtensionTask"})," block. Specify target platforms using ",(0,i.jsx)(t.code,{children:"ext.cross_platform"}),"."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ruby",children:'# Rakefile\nrequire "rb_sys/extensiontask"\n\nGEMSPEC = Gem::Specification.load("my_gem.gemspec")\n\nRbSys::ExtensionTask.new("my_gem", GEMSPEC) do |ext|\n  ext.cross_compile = true\n  ext.cross_platform = [\n    "x86_64-linux",\n    "aarch64-linux",\n    "x86_64-darwin",\n    "arm64-darwin",\n    "x64-mingw-ucrt",\n  ]\nend\n'})}),"\n",(0,i.jsx)(t.h3,{id:"usage",children:"Usage"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Build all platforms:"})," ",(0,i.jsx)(t.code,{children:"bundle exec rake native"})]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Build a specific platform:"})," ",(0,i.jsx)(t.code,{children:"bundle exec rake native:my_gem:x86_64-linux"})]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsxs)(t.strong,{children:["Use ",(0,i.jsx)(t.code,{children:"rb-sys-dock"})," directly:"]})," ",(0,i.jsx)(t.code,{children:"bundle exec rb-sys-dock --platform x86_64-linux --build"})]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"cicd-release-workflow",children:"CI/CD Release Workflow"}),"\n",(0,i.jsxs)(t.p,{children:["Automate gem building and publishing with this GitHub Actions workflow, leveraging ",(0,i.jsx)(t.code,{children:"oxidize-rb/actions"})," for simplified setup."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:'# .github/workflows/release.yml\nname: Gem Release\n\non:\n  push:\n    tags:\n      - "v*"\n\njobs:\n  test:\n    strategy:\n      fail-fast: false\n      matrix:\n        os: [ubuntu-latest, macos-latest, windows-latest]\n        ruby: ["3.0", "3.1", "3.2", "3.3"]\n    runs-on: ${{ matrix.os }}\n    steps:\n      - uses: actions/checkout@v4\n      - uses: oxidize-rb/actions/setup-ruby-and-rust@v1\n        with:\n          ruby-version: ${{ matrix.ruby }}\n          bundler-cache: true\n      - run: bundle exec rake compile\n      - run: bundle exec rake test\n\n  cross-compile:\n    needs: [test]\n    runs-on: ubuntu-latest\n    strategy:\n      fail-fast: false\n      matrix:\n        platform: ["x86_64-linux", "aarch64-linux", "x86_64-darwin", "arm64-darwin", "x64-mingw-ucrt"]\n    steps:\n      - uses: actions/checkout@v4\n      - uses: ruby/setup-ruby@v1\n        with:\n          ruby-version: "3.1"\n      - uses: oxidize-rb/actions/cross-gem@v1\n        with:\n          platform: ${{ matrix.platform }}\n      - uses: actions/upload-artifact@v3\n        with:\n          name: gem-${{ matrix.platform }}\n          path: pkg/*-${{ matrix.platform }}.gem\n\n  release:\n    needs: cross-compile\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/download-artifact@v3\n        with:\n          path: artifacts\n      - name: Move gems to pkg directory\n        run: |\n          mkdir -p pkg\n          find artifacts -name "*.gem" -exec mv {} pkg/ \\;\n      - name: Publish to RubyGems\n        env:\n          RUBYGEMS_API_KEY: ${{ secrets.RUBYGEMS_API_KEY }}\n        run: |\n          mkdir -p ~/.gem\n          echo "---\n          :rubygems_api_key: ${RUBYGEMS_API_KEY}" > ~/.gem/credentials\n          chmod 0600 ~/.gem/credentials\n          gem push pkg/*.gem\n'})})]})}function x(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>l,x:()=>o});var s=n(6540);const i={},r=s.createContext(i);function l(e){const t=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);