"use strict";(self.webpackChunkdocsite=self.webpackChunkdocsite||[]).push([[784],{5786:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>o,default:()=>g,frontMatter:()=>l,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"debugging","title":"Debugging","description":"This guide provides techniques for debugging Rust-based Ruby extensions, covering debuggers, memory analysis, and logging.","source":"@site/docs/debugging.mdx","sourceDirName":".","slug":"/debugging","permalink":"/docs/debugging","draft":false,"unlisted":false,"editUrl":"https://github.com/oxidize-rb/rb-sys/tree/main/docsite/docs/debugging.mdx","tags":[],"version":"current","lastUpdatedBy":"dependabot[bot]","lastUpdatedAt":1763832420000,"frontMatter":{"id":"debugging","title":"Debugging"},"sidebar":"docsSidebar","previous":{"title":"Testing","permalink":"/docs/testing"},"next":{"title":"Troubleshooting","permalink":"/docs/troubleshooting"}}');var r=s(4848),d=s(8453);const l={id:"debugging",title:"Debugging"},o="Debugging",t={},c=[{value:"Compiling with Debug Symbols",id:"compiling-with-debug-symbols",level:2},{value:"Using a Debugger (GDB/LLDB)",id:"using-a-debugger-gdblldb",level:2},{value:"Live Session",id:"live-session",level:3},{value:"Post-Mortem Debugging (Core Dumps)",id:"post-mortem-debugging-core-dumps",level:3},{value:"VSCode Configuration",id:"vscode-configuration",level:3},{value:"Logging",id:"logging",level:2},{value:"Setup",id:"setup",level:3},{value:"Usage",id:"usage",level:3},{value:"Memory Leak Detection",id:"memory-leak-detection",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,d.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"debugging",children:"Debugging"})}),"\n",(0,r.jsx)(n.p,{children:"This guide provides techniques for debugging Rust-based Ruby extensions, covering debuggers, memory analysis, and logging."}),"\n",(0,r.jsx)(n.h2,{id:"compiling-with-debug-symbols",children:"Compiling with Debug Symbols"}),"\n",(0,r.jsxs)(n.p,{children:["To effectively debug your extension, compile it with debug symbols. Use the ",(0,r.jsx)(n.code,{children:"dev"})," Cargo profile."]}),"\n",(0,r.jsx)(n.p,{children:"Set the profile with an environment variable:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"RB_SYS_CARGO_PROFILE=dev bundle exec rake compile\n"})}),"\n",(0,r.jsx)(n.p,{children:"Or create a Rake task:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ruby",children:'# Rakefile\ndesc "Compile the extension with debug symbols"\ntask "compile:debug" do\n  ENV["RB_SYS_CARGO_PROFILE"] = "dev"\n  Rake::Task["compile"].invoke\nend\n'})}),"\n",(0,r.jsx)(n.h2,{id:"using-a-debugger-gdblldb",children:"Using a Debugger (GDB/LLDB)"}),"\n",(0,r.jsx)(n.h3,{id:"live-session",children:"Live Session"}),"\n",(0,r.jsxs)(n.p,{children:["Run your Ruby process inside ",(0,r.jsx)(n.code,{children:"gdb"})," or ",(0,r.jsx)(n.code,{children:"lldb"})," to catch crashes and inspect state."]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Start the debugger:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# LLDB on macOS\nlldb -- ruby -Ilib -e 'require \"my_extension\"; MyExtension.method_to_debug'\n\n# GDB on Linux\ngdb --args ruby -Ilib -e 'require \"my_extension\"; MyExtension.method_to_debug'\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Set a breakpoint and run:"}),"\nSet breakpoints on Rust functions (e.g., by file and line number)."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"(lldb) breakpoint set --file src/lib.rs --line 42\n(lldb) run\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"post-mortem-debugging-core-dumps",children:"Post-Mortem Debugging (Core Dumps)"}),"\n",(0,r.jsx)(n.p,{children:"Analyze core dumps for segmentation faults."}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Enable core dumps"})," (Linux/macOS): ",(0,r.jsx)(n.code,{children:"ulimit -c unlimited"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Run the code"})," that causes the crash to generate a ",(0,r.jsx)(n.code,{children:"core"})," file."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Load the core dump:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"gdb --core=core --quiet `which ruby`\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Get a backtrace:"})," Use ",(0,r.jsx)(n.code,{children:"bt"})," to show the stack trace."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"vscode-configuration",children:"VSCode Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"vadimcn.vscode-lldb"})," extension provides integrated debugging."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'// .vscode/launch.json\n{\n  "version": "0.2.0",\n  "configurations": [\n    {\n      "type": "lldb",\n      "request": "launch",\n      "name": "Debug Extension",\n      "preLaunchTask": "rake: compile:debug",\n      "program": "/path/to/your/ruby",\n      "args": ["-Ilib", "-r", "my_gem", "my_script.rb"],\n      "cwd": "${workspaceFolder}",\n      "sourceLanguages": ["rust"]\n    }\n  ]\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"logging",children:"Logging"}),"\n",(0,r.jsx)(n.p,{children:"Structured logging is invaluable for development and production."}),"\n",(0,r.jsx)(n.h3,{id:"setup",children:"Setup"}),"\n",(0,r.jsxs)(n.p,{children:["Use the ",(0,r.jsx)(n.code,{children:"log"})," and ",(0,r.jsx)(n.code,{children:"env_logger"})," crates."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-toml",children:'# Cargo.toml\n[dependencies]\nlog = "0.4"\nenv_logger = "0.10"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Initialize ",(0,r.jsx)(n.code,{children:"env_logger"})," in your extension's ",(0,r.jsx)(n.code,{children:"Init"})," function."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:"#[magnus::init]\nfn init() {\n    env_logger::init();\n    // ...\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"usage",children:"Usage"}),"\n",(0,r.jsxs)(n.p,{children:["Run your Ruby code with ",(0,r.jsx)(n.code,{children:"RUST_LOG"})," set to the desired log level (",(0,r.jsx)(n.code,{children:"error"}),", ",(0,r.jsx)(n.code,{children:"warn"}),", ",(0,r.jsx)(n.code,{children:"info"}),", ",(0,r.jsx)(n.code,{children:"debug"}),", ",(0,r.jsx)(n.code,{children:"trace"}),")."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"RUST_LOG=debug ruby my_script.rb\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:'// In your Rust code\nuse log::{debug, info};\n\nfn my_function(some_data: &[i64]) {\n    debug!("Starting operation with data: {:?}", some_data);\n    // ...\n    info!("Operation completed successfully.");\n}\n\nfn another_function() {\n    my_function(&[1, 2, 3]);\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"memory-leak-detection",children:"Memory Leak Detection"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.a,{href:"https://github.com/Shopify/ruby_memcheck",children:(0,r.jsx)(n.code,{children:"ruby_memcheck"})})," to detect memory leaks, filtering out Ruby's GC noise."]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Install dependencies:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"gem install ruby_memcheck\n# Debian/Ubuntu\napt-get install valgrind\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Set up a Rake task:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ruby",children:'# Rakefile\nrequire \'ruby_memcheck\'\n\nnamespace :test do\n  RubyMemcheck::TestTask.new(valgrind: :compile) do |t|\n    t.libs << "test"\n    t.test_files = FileList["test/**/*_test.rb"]\n  end\nend\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Run the task:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"bundle exec rake test:valgrind\n"})}),"\n"]}),"\n"]})]})}function g(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>o});var i=s(6540);const r={},d=i.createContext(r);function l(e){const n=i.useContext(d);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),i.createElement(d.Provider,{value:n},e.children)}}}]);