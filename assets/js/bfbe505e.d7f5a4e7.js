"use strict";(self.webpackChunkdocsite=self.webpackChunkdocsite||[]).push([[5505],{1785:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>l,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"api-reference/test-helpers","title":"Testing with `rb-sys-test-helpers`","description":"The rb-sys-test-helpers crate provides utilities for running Rust unit and integration tests within a live Ruby VM.","source":"@site/docs/api-reference/test-helpers.mdx","sourceDirName":"api-reference","slug":"/api-reference/test-helpers","permalink":"/docs/api-reference/test-helpers","draft":false,"unlisted":false,"editUrl":"https://github.com/oxidize-rb/rb-sys/tree/main/docsite/docs/api-reference/test-helpers.mdx","tags":[],"version":"current","lastUpdatedBy":"dependabot[bot]","lastUpdatedAt":1763832465000,"frontMatter":{"id":"test-helpers","title":"Testing with `rb-sys-test-helpers`"},"sidebar":"docsSidebar","previous":{"title":"Gem Configuration","permalink":"/docs/api-reference/rb-sys-gem-config"},"next":{"title":"Cookbook","permalink":"/docs/cookbook"}}');var r=t(4848),i=t(8453);const l={id:"test-helpers",title:"Testing with `rb-sys-test-helpers`"},o="Testing with rb-sys-test-helpers",c={},d=[{value:"Setup",id:"setup",level:2},{value:"Example Test Module",id:"example-test-module",level:2},{value:"Mechanism",id:"mechanism",level:2},{value:"Testing Multiple Ruby Versions",id:"testing-multiple-ruby-versions",level:2}];function a(e){const s={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsxs)(s.h1,{id:"testing-with-rb-sys-test-helpers",children:["Testing with ",(0,r.jsx)(s.code,{children:"rb-sys-test-helpers"})]})}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"rb-sys-test-helpers"})," crate provides utilities for running Rust unit and integration tests within a live Ruby VM."]}),"\n",(0,r.jsx)(s.h2,{id:"setup",children:"Setup"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsxs)(s.strong,{children:["Add ",(0,r.jsx)(s.code,{children:"dev-dependencies"})," to ",(0,r.jsx)(s.code,{children:"Cargo.toml"})]}),":"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-toml",children:'[dev-dependencies]\nrb-sys-env = "0.1"\nrb-sys-test-helpers = "0.2"\n'})}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsxs)(s.strong,{children:["Activate ",(0,r.jsx)(s.code,{children:"rb-sys"})," in ",(0,r.jsx)(s.code,{children:"build.rs"})]}),":"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-rust,ignore",children:"// build.rs\nfn main() -> Result<(), Box<dyn std::error::Error>> {\n    rb_sys::activate()?;\n    Ok(())\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsxs)(s.strong,{children:["Annotate tests with ",(0,r.jsx)(s.code,{children:"#[ruby_test]"})]}),":\nUse the ",(0,r.jsx)(s.code,{children:"#[ruby_test]"})," attribute on test functions that interact with the Ruby API."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"example-test-module",children:"Example Test Module"}),"\n",(0,r.jsxs)(s.p,{children:["A single test module can combine ",(0,r.jsx)(s.code,{children:"rb-sys"}),", ",(0,r.jsx)(s.code,{children:"magnus"}),", and ",(0,r.jsx)(s.code,{children:"proptest"})," examples."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-rust",children:'#[cfg(test)]\nmod tests {\n    use rb_sys_test_helpers::ruby_test;\n    use rb_sys::{rb_num2fix, FIXNUM_P};\n    use magnus::{Ruby, RString};\n    use proptest::prelude::*;\n\n    #[ruby_test]\n    fn test_raw_rb_sys_api() {\n        let int = unsafe { rb_num2fix(123) };\n        assert!(FIXNUM_P(int));\n    }\n\n    #[ruby_test]\n    fn test_with_magnus() {\n        let ruby = unsafe { Ruby::get_unchecked() };\n        let string = ruby.str_new("Hello, Magnus!");\n        assert_eq!(string.to_string().ok(), Some("Hello, Magnus!".to_string()));\n    }\n\n    #[ruby_test]\n    fn test_with_proptest() {\n        proptest!(|(s in "[a-z]*")| {\n            let ruby = unsafe { Ruby::get_unchecked() };\n            let ruby_string = ruby.str_new(&s);\n            assert_eq!(ruby_string.to_string().ok(), Some(s));\n        });\n    }\n}\n'})}),"\n",(0,r.jsx)(s.h2,{id:"mechanism",children:"Mechanism"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"#[ruby_test]"})," initializes a Ruby VM before your test and tears it down afterward."]}),"\n",(0,r.jsxs)(s.li,{children:["Allows ",(0,r.jsx)(s.code,{children:"unsafe"})," calls to ",(0,r.jsx)(s.code,{children:"rb_sys"})," or ",(0,r.jsx)(s.code,{children:"magnus::Ruby::get_unchecked()"})," within the test scope."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"testing-multiple-ruby-versions",children:"Testing Multiple Ruby Versions"}),"\n",(0,r.jsxs)(s.p,{children:["Use a CI matrix to run your ",(0,r.jsx)(s.code,{children:"cargo test"})," suite against all supported Ruby versions."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",children:'# .github/workflows/ci.yml\njobs:\n  test:\n    strategy:\n      matrix:\n        ruby: ["2.7", "3.0", "3.1", "3.2", "3.3"]\n    steps:\n      - uses: actions/checkout@v4\n      - uses: oxidize-rb/actions/setup-ruby-and-rust@v1\n        with:\n          ruby-version: ${{ matrix.ruby }}\n      - run: cargo test\n'})})]})}function u(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},8453:(e,s,t)=>{t.d(s,{R:()=>l,x:()=>o});var n=t(6540);const r={},i=n.createContext(r);function l(e){const s=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),n.createElement(i.Provider,{value:s},e.children)}}}]);