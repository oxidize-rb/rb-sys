"use strict";(self.webpackChunkdocsite=self.webpackChunkdocsite||[]).push([[7213],{6613:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>d,contentTitle:()=>c,default:()=>u,frontMatter:()=>l,metadata:()=>s,toc:()=>t});const s=JSON.parse('{"id":"build-process","title":"The Build Process","description":"This page explains the compilation steps for a Rust-based Ruby gem, aiding in debugging and optimization.","source":"@site/docs/build-process.mdx","sourceDirName":".","slug":"/build-process","permalink":"/docs/build-process","draft":false,"unlisted":false,"editUrl":"https://github.com/oxidize-rb/rb-sys/tree/main/docsite/docs/build-process.mdx","tags":[],"version":"current","lastUpdatedBy":"Ian Ker-Seymer","lastUpdatedAt":1765922612000,"frontMatter":{"id":"build-process","title":"The Build Process"},"sidebar":"docsSidebar","previous":{"title":"Memory Management & Safety","permalink":"/docs/memory-management"},"next":{"title":"Deployment & Distribution","permalink":"/docs/deployment"}}');var r=n(4848),o=n(8453);const l={id:"build-process",title:"The Build Process"},c="The Build Process",d={},t=[{value:"Compilation Steps",id:"compilation-steps",level:2},{value:"Build Configuration",id:"build-configuration",level:2},{value:"Debugging a Failing Build",id:"debugging-a-failing-build",level:2},{value:"Optimizing Builds",id:"optimizing-builds",level:2},{value:"Cross-Compilation",id:"cross-compilation",level:2}];function a(e){const i={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.header,{children:(0,r.jsx)(i.h1,{id:"the-build-process",children:"The Build Process"})}),"\n",(0,r.jsx)(i.p,{children:"This page explains the compilation steps for a Rust-based Ruby gem, aiding in debugging and optimization."}),"\n",(0,r.jsx)(i.h2,{id:"compilation-steps",children:"Compilation Steps"}),"\n",(0,r.jsxs)(i.p,{children:["When you run ",(0,r.jsx)(i.code,{children:"bundle exec rake compile"}),", the process involves:"]}),"\n",(0,r.jsxs)(i.ol,{children:["\n",(0,r.jsxs)(i.li,{children:[(0,r.jsxs)(i.strong,{children:[(0,r.jsx)(i.code,{children:"extconf.rb"})," execution:"]})," Ruby's ",(0,r.jsx)(i.code,{children:"mkmf"})," (make-makefile) library runs your extension's ",(0,r.jsx)(i.code,{children:"extconf.rb"})," script."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Makefile generation:"})," The ",(0,r.jsx)(i.code,{children:"create_rust_makefile"})," helper from ",(0,r.jsx)(i.code,{children:"rb-sys"})," generates a ",(0,r.jsx)(i.code,{children:"Makefile"})," configured to build your Rust code."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsxs)(i.strong,{children:[(0,r.jsx)(i.code,{children:"cargo build"})," invocation:"]})," The ",(0,r.jsx)(i.code,{children:"Makefile"})," calls ",(0,r.jsx)(i.code,{children:"cargo build"})," to compile your Rust crate into a dynamic shared library."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Library copying:"})," The compiled library is moved into your gem's ",(0,r.jsx)(i.code,{children:"lib"})," directory for Ruby to load."]}),"\n"]}),"\n",(0,r.jsx)(i.h2,{id:"build-configuration",children:"Build Configuration"}),"\n",(0,r.jsxs)(i.p,{children:["Configure the build process in your ",(0,r.jsx)(i.code,{children:"extconf.rb"})," file via the ",(0,r.jsx)(i.code,{children:"create_rust_makefile"})," helper."]}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-ruby",children:'# ext/my_gem/extconf.rb\nrequire "mkmf"\nrequire "rb_sys/mkmf"\n\ncreate_rust_makefile("my_gem") do |config|\n  config.profile = :release # Set the Cargo profile, e.g., :dev or :release\n  config.features = ["my-feature"] # Enable specific Cargo features\nend\n'})}),"\n",(0,r.jsxs)(i.p,{children:["For a complete list of configuration options and environment variables, see the ",(0,r.jsx)(i.a,{href:"/docs/api-reference/rb-sys-gem-config",children:"Gem Configuration"})," reference."]}),"\n",(0,r.jsx)(i.h2,{id:"debugging-a-failing-build",children:"Debugging a Failing Build"}),"\n",(0,r.jsxs)(i.p,{children:["If ",(0,r.jsx)(i.code,{children:"rake compile"})," fails, use these steps to diagnose the issue:"]}),"\n",(0,r.jsxs)(i.ol,{children:["\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"Enable Verbose Output:"})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-bash",children:"bundle exec rake compile VERBOSE=1\n"})}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.strong,{children:"Inspect the Makefile:"}),"\nCheck ",(0,r.jsx)(i.code,{children:"ext/my_gem/Makefile"})," to see the exact ",(0,r.jsx)(i.code,{children:"cargo"})," commands being run."]}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.strong,{children:"Run Cargo Directly:"}),"\nChange into your extension directory and run ",(0,r.jsx)(i.code,{children:"cargo build"})," manually."]}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-bash",children:"cd ext/my_gem\ncargo build --verbose\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(i.h2,{id:"optimizing-builds",children:"Optimizing Builds"}),"\n",(0,r.jsxs)(i.p,{children:["For production gems, always compile with the ",(0,r.jsx)(i.code,{children:"release"})," profile to enable optimizations. Control this with ",(0,r.jsx)(i.code,{children:"config.profile"})," in ",(0,r.jsx)(i.code,{children:"extconf.rb"})," or the ",(0,r.jsx)(i.code,{children:"RB_SYS_CARGO_PROFILE"})," environment variable."]}),"\n",(0,r.jsxs)(i.p,{children:["Tune release builds in your ",(0,r.jsx)(i.code,{children:"Cargo.toml"}),":"]}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-toml",children:"[profile.release]\nlto = true         # Enable Link-Time Optimization\nopt-level = 3      # Maximum optimization level\ncodegen-units = 1  # Slower to compile, but produces a smaller/faster binary\n"})}),"\n",(0,r.jsx)(i.h2,{id:"cross-compilation",children:"Cross-Compilation"}),"\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"rb-sys"})," can compile your gem for different platforms (e.g., Linux, macOS, Windows) from a single machine using ",(0,r.jsx)(i.code,{children:"rb-sys-dock"}),"."]}),"\n",(0,r.jsxs)(i.p,{children:["Enable cross-compilation in your ",(0,r.jsx)(i.code,{children:"Rakefile"}),":"]}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-ruby",children:'# Rakefile\nRbSys::ExtensionTask.new("my_gem", GEMSPEC) do |ext|\n  ext.cross_compile = true\nend\n'})}),"\n",(0,r.jsx)(i.p,{children:"Build for a specific platform:"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-bash",children:"bundle exec rake native:my_gem:x86_64-linux\n"})}),"\n",(0,r.jsxs)(i.p,{children:["For a complete guide on setting up cross-compilation and CI/CD workflows, see the ",(0,r.jsx)(i.a,{href:"/docs/deployment",children:"Deployment & Distribution"})," guide."]})]})}function u(e={}){const{wrapper:i}={...(0,o.R)(),...e.components};return i?(0,r.jsx)(i,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},8453:(e,i,n)=>{n.d(i,{R:()=>l,x:()=>c});var s=n(6540);const r={},o=s.createContext(r);function l(e){const i=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function c(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(o.Provider,{value:i},e.children)}}}]);