<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Anatomy of a Rusty Ruby Gem: hello_rusty - The Ruby on Rust Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="A comprehensive guide to building Ruby extensions with Rust using rb-sys">
        <meta name="keywords" content="ruby, rust, ffi, bindings, rb-sys, ruby on rust">
        <meta name="author" content="">
        
        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website">
        <meta property="og:url" content="">
        <meta property="og:title" content="Anatomy of a Rusty Ruby Gem: hello_rusty - The Ruby on Rust Book">
        <meta property="og:description" content="A comprehensive guide to building Ruby extensions with Rust using rb-sys">
        
        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="">
        <meta property="twitter:title" content="Anatomy of a Rusty Ruby Gem: hello_rusty - The Ruby on Rust Book">
        <meta property="twitter:description" content="A comprehensive guide to building Ruby extensions with Rust using rb-sys">
        
        <!-- Canonical URL -->
        <link rel="canonical" href="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/css/custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Ruby on Rust Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/oxidize-rb/rb-sys" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="anatomy-of-a-rusty-ruby-gem-hello_rusty"><a class="header" href="#anatomy-of-a-rusty-ruby-gem-hello_rusty">Anatomy of a Rusty Ruby Gem: hello_rusty</a></h1>
<p>This documentation provides a comprehensive walkthrough of the <code>hello_rusty</code> gem, a simple but complete Ruby gem that
uses Rust for its native extension. This example demonstrates the key components of creating a Ruby gem with Rust using
rb-sys and magnus.</p>
<h2 id="project-structure"><a class="header" href="#project-structure">Project Structure</a></h2>
<p>A properly structured Rusty Ruby Gem follows the standard Ruby gem conventions with the addition of Rust-specific
elements. Here's the structure of the <code>hello_rusty</code> gem:</p>
<pre><code>hello_rusty/
├── bin/                      # Executable files
├── ext/                      # Native extension code
│   └── hello_rusty/          # The Rust extension directory
│       ├── Cargo.toml        # Rust package manifest
│       ├── extconf.rb        # Ruby extension configuration
│       └── src/
│           └── lib.rs        # Rust implementation
├── lib/                      # Ruby code
│   ├── hello_rusty.rb        # Main Ruby file
│   └── hello_rusty/
│       └── version.rb        # Version definition
├── sig/                      # RBS type signatures
│   └── hello_rusty.rbs       # Type definitions
├── test/                     # Test files
│   ├── test_hello_rusty.rb   # Test for the gem
│   └── test_helper.rb        # Test setup
├── Cargo.lock                # Rust dependency lock file
├── Cargo.toml                # Workspace-level Rust config (optional)
├── Gemfile                   # Ruby dependencies
├── LICENSE.txt               # License file
├── Rakefile                  # Build tasks
├── README.md                 # Documentation
└── hello_rusty.gemspec       # Gem specification
</code></pre>
<h2 id="key-components"><a class="header" href="#key-components">Key Components</a></h2>
<h3 id="1-ruby-components"><a class="header" href="#1-ruby-components">1. Ruby Components</a></h3>
<h4 id="gemspec-hello_rustygemspec"><a class="header" href="#gemspec-hello_rustygemspec">Gemspec (<code>hello_rusty.gemspec</code>)</a></h4>
<p>The gemspec defines metadata about the gem and specifies build requirements:</p>
<pre><code class="language-ruby"># frozen_string_literal: true

require_relative "lib/hello_rusty/version"

Gem::Specification.new do |spec|
  spec.name = "hello_rusty"
  spec.version = HelloRusty::VERSION
  spec.authors = ["Ian Ker-Seymer"]
  spec.email = ["hello@ianks.com"]

  # ... metadata ...

  spec.required_ruby_version = "&gt;= 3.0.0"

  # Files to include in the gem
  spec.files = [...]

  # IMPORTANT: This line tells RubyGems that this gem has a native extension
  # and where to find the build configuration
  spec.extensions = ["ext/hello_rusty/Cargo.toml"]

  spec.require_paths = ["lib"]
end
</code></pre>
<p>Key points:</p>
<ul>
<li>The <code>extensions</code> field points to the Cargo.toml file</li>
<li>Version is defined in a separate Ruby file</li>
<li>Required Ruby version is specified</li>
</ul>
<h4 id="main-ruby-file-libhello_rustyrb"><a class="header" href="#main-ruby-file-libhello_rustyrb">Main Ruby file (<code>lib/hello_rusty.rb</code>)</a></h4>
<pre><code class="language-ruby"># frozen_string_literal: true

require_relative "hello_rusty/version"
require_relative "hello_rusty/hello_rusty"  # Loads the compiled Rust extension

module HelloRusty
  class Error &lt; StandardError; end
  # Additional Ruby code can go here
end
</code></pre>
<p>Key points:</p>
<ul>
<li>Requires the version file</li>
<li>Requires the compiled native extension</li>
<li>Defines a module matching the Rust module</li>
</ul>
<h4 id="version-file-libhello_rustyversionrb"><a class="header" href="#version-file-libhello_rustyversionrb">Version file (<code>lib/hello_rusty/version.rb</code>)</a></h4>
<pre><code class="language-ruby"># frozen_string_literal: true

module HelloRusty
  VERSION = "0.1.0"
end
</code></pre>
<h4 id="type-definitions-sighello_rustyrbs"><a class="header" href="#type-definitions-sighello_rustyrbs">Type Definitions (<code>sig/hello_rusty.rbs</code>)</a></h4>
<p>RBS type definitions for better IDE support and type checking:</p>
<pre><code class="language-rbs">module HelloRusty
  VERSION: String
  # Add type signatures for your methods here
end
</code></pre>
<h3 id="2-rust-components"><a class="header" href="#2-rust-components">2. Rust Components</a></h3>
<h4 id="cargo-configuration-exthello_rustycargotoml"><a class="header" href="#cargo-configuration-exthello_rustycargotoml">Cargo Configuration (<code>ext/hello_rusty/Cargo.toml</code>)</a></h4>
<pre><code class="language-toml">[package]
name = "hello_rusty"
version = "0.1.0"
edition = "2021"
authors = ["Ian Ker-Seymer &lt;hello@ianks.com&gt;"]
license = "MIT"
publish = false

[lib]
crate-type = ["cdylib"]  # Outputs a dynamic library

[dependencies]
magnus = { version = "0.6.2" }  # High-level Ruby bindings
</code></pre>
<p>Key points:</p>
<ul>
<li>Uses <code>cdylib</code> crate type to build a dynamic library</li>
<li>Depends on <code>magnus</code> for high-level Ruby bindings</li>
<li>Version should match the Ruby gem version</li>
</ul>
<h4 id="rust-implementation-exthello_rustysrclibrs"><a class="header" href="#rust-implementation-exthello_rustysrclibrs">Rust Implementation (<code>ext/hello_rusty/src/lib.rs</code>)</a></h4>
<p>Here's the actual implementation from our example code:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use magnus::{function, prelude::*, Error, Ruby};

fn hello(subject: String) -&gt; String {
    format!("Hello from Rust, {subject}!")
}

#[magnus::init]
fn init(ruby: &amp;Ruby) -&gt; Result&lt;(), Error&gt; {
    let module = ruby.define_module("HelloRusty")?;
    module.define_singleton_method("hello", function!(hello, 1))?;
    Ok(())
}
<span class="boring">}</span></code></pre></pre>
<div class="note">
<p>This code is included directly from the example project file. When the source file is updated, this documentation will
automatically reflect those changes.</p>
</div>
<p>Key points:</p>
<ul>
<li>Uses the <code>magnus</code> crate for Ruby integration</li>
<li>The <code>#[magnus::init]</code> macro marks the entry point for the extension</li>
<li>Defines a Ruby module matching the gem name</li>
<li>Exposes the <code>hello</code> Rust function as a Ruby method</li>
</ul>
<h3 id="3-build-system"><a class="header" href="#3-build-system">3. Build System</a></h3>
<h4 id="extension-configuration-exthello_rustyextconfrb"><a class="header" href="#extension-configuration-exthello_rustyextconfrb">Extension Configuration (<code>ext/hello_rusty/extconf.rb</code>)</a></h4>
<pre><code class="language-ruby"># frozen_string_literal: true

require "mkmf"
require "rb_sys/mkmf"

create_rust_makefile("hello_rusty/hello_rusty")
</code></pre>
<p>Key points:</p>
<ul>
<li>Uses <code>rb_sys/mkmf</code> to handle Rust compilation</li>
<li>Creates a makefile for the native extension</li>
</ul>
<h4 id="rakefile-rakefile"><a class="header" href="#rakefile-rakefile">Rakefile (<code>Rakefile</code>)</a></h4>
<p>Here's the actual Rakefile from our example project:</p>
<pre><code class="language-ruby hidelines=#"><span class="boring"> frozen_string_literal: true
</span>
require "bundler/gem_tasks"
require "minitest/test_task"

Minitest::TestTask.create

require "rubocop/rake_task"

RuboCop::RakeTask.new

require "rb_sys/extensiontask"

task build: :compile

GEMSPEC = Gem::Specification.load("hello_rusty.gemspec")

RbSys::ExtensionTask.new("hello_rusty", GEMSPEC) do |ext|
  ext.lib_dir = "lib/hello_rusty"
end

task default: %i[compile test rubocop]

<span class="boring"> You can customize the build further:
</span><span class="boring"> RbSys::ExtensionTask.new("hello_rusty", GEMSPEC) do |ext|
</span><span class="boring">   ext.lib_dir = "lib/hello_rusty"
</span><span class="boring">   ext.cross_compile = true  # Enable cross-compilation
</span><span class="boring">   ext.cross_platform = ['x86_64-linux', 'x86_64-darwin']  # Platforms to target
</span><span class="boring"> end
</span></code></pre>
<div class="tip">
<p>The eye icon (<i class="fa fa-eye"></i>) reveals additional configuration options you can use in your Rakefile.</p>
</div>
<p>Key points:</p>
<ul>
<li>Uses <code>RbSys::ExtensionTask</code> to manage Rust compilation</li>
<li>Sets the output directory to <code>lib/hello_rusty</code></li>
<li>Defines standard tasks for building, testing, and linting</li>
</ul>
<h3 id="4-testing"><a class="header" href="#4-testing">4. Testing</a></h3>
<h4 id="test-file-testtest_hello_rustyrb"><a class="header" href="#test-file-testtest_hello_rustyrb">Test File (<code>test/test_hello_rusty.rb</code>)</a></h4>
<pre><code class="language-ruby"># frozen_string_literal: true

require "test_helper"

class TestHelloRusty &lt; Minitest::Test
  def test_that_it_has_a_version_number
    refute_nil ::HelloRusty::VERSION
  end

  def test_hello
    result = HelloRusty.hello("World")
    assert_equal "Hello from Rust, World!", result
  end
end
</code></pre>
<p>Key points:</p>
<ul>
<li>Tests basic functionality of the gem</li>
<li>Verifies the version is defined</li>
<li>Tests the Rust-implemented <code>hello</code> method</li>
</ul>
<h2 id="build-process"><a class="header" href="#build-process">Build Process</a></h2>
<p>When building a Rusty Ruby Gem, the following steps occur:</p>
<ol>
<li><code>rake compile</code> is run (either directly or through <code>rake build</code>)</li>
<li>The <code>RbSys::ExtensionTask</code> processes the extension:
<ul>
<li>It reads the <code>ext/hello_rusty/Cargo.toml</code> file</li>
<li>It sets up the appropriate build environment</li>
<li>It runs <code>cargo build</code> with the appropriate options</li>
<li>It copies the resulting <code>.so</code>/<code>.bundle</code>/<code>.dll</code> to <code>lib/hello_rusty/</code></li>
</ul>
</li>
<li>The compiled binary is then packaged into the gem</li>
</ol>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>Once installed, this gem can be used in Ruby code as follows:</p>
<pre><code class="language-ruby">require "hello_rusty"

# Call the Rust-implemented method
greeting = HelloRusty.hello("Rusty Rubyist")
puts greeting  # =&gt; "Hello from Rust, Rusty Rubyist!"
</code></pre>
<h2 id="key-concepts-demonstrated"><a class="header" href="#key-concepts-demonstrated">Key Concepts Demonstrated</a></h2>
<ol>
<li><strong>Module Structure</strong>: The gem defines a Ruby module that's implemented in Rust</li>
<li><strong>Function Exposure</strong>: Rust functions are exposed as Ruby methods</li>
<li><strong>Type Conversion</strong>: Rust handles string conversion automatically through magnus</li>
<li><strong>Error Handling</strong>: The Rust code uses <code>Result&lt;T, Error&gt;</code> for Ruby-compatible error handling</li>
<li><strong>Build Integration</strong>: The gem uses rb-sys to integrate with Ruby's build system</li>
<li><strong>Testing</strong>: Standard Ruby testing tools work with the Rust-implemented functionality</li>
</ol>
<h2 id="next-steps-for-expansion"><a class="header" href="#next-steps-for-expansion">Next Steps for Expansion</a></h2>
<p>To expand this basic example, you could:</p>
<ol>
<li>Add Ruby classes backed by Rust structs using TypedData</li>
<li>Implement more complex methods with various argument types</li>
<li>Add error handling with custom Ruby exceptions</li>
<li>Use the Ruby GVL (Global VM Lock) for thread safety</li>
<li>Implement memory management through proper object marking</li>
<li>Add benchmarks to demonstrate performance characteristics</li>
</ol>
<p>This example provides a solid foundation for understanding the structure and implementation of Rusty Ruby Gems with
rb-sys.</p>

                    </main>

                    <nav class="nav-wrapper" style="margin-bottom: 0;" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="project-setup.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="development-approaches.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                    
                    <div class="footer-note" style="margin: 3rem 0 0 0; padding: 2rem; font-size: 1.1rem; color: #555; border-top: 1px solid #ddd; display: flex; justify-content: center; align-items: center; font-family: inherit;">
                        <div style="max-width: 800px; text-align: center; line-height: 1.6;">
                            This documentation was created with assistance from an LLM.<br>
                            If you spot any issues, please <a href="https://github.com/oxidize-rb/rb-sys/issues" style="color: #3184a8; text-decoration: none; font-weight: bold;">submit a fix or report it</a>.<br>
                            We appreciate your help in improving these docs!
                        </div>
                    </div>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="project-setup.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="development-approaches.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="theme/js/custom.js"></script>


    </div>
    </body>
</html>
